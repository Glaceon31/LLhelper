{% extends "layout.html" %}

{% set category="队伍编成和强度" %}
{% set category_link="/#unit-formation" %}
{% set title="自动组队" %}

{% block additional_header %}
   <script type="text/javascript" src="{{ url_for('static', filename='twintailosu.js') }}?v=1.01"></script>
   <script type="text/javascript" src="{{ url_for('static', filename='llsong.js') }}"></script>
   <script type="text/javascript" src="{{ url_for('static', filename='llcard.js') }}"></script>
   <script type="text/javascript" src="{{ url_for('static', filename='lldata.js') }}"></script>
   <link rel="shortcut icon" href="/static/shortcuticon.png" />
   <style type="text/css">
   	img {height:65px;width:65px}
   </style>
{% endblock %}

{% block script %}
   <script>
   var regS = new RegExp("&#34;", "g")
   var regS2 = new RegExp("&#39;", "g")
   var regSand = new RegExp("&amp;", "g")
   var songsjson = "{{songsjson}}".replace(regS,'"').replace(regS2, "'").replace(regSand, '&')
   var llsong = new LLSong(songsjson);
   //var llcard = new LLCard(cardsjson);
   var llcard = 0;

   var attcolor = new Array();
   var mezame = 0
   var language = 0
   attcolor["smile"] = "red"
   attcolor["pure"] = "green"
   attcolor["cool"] = "blue"
   attcolor[""] = "purple"
   var kizuna = new Array();
   kizuna["N"] = [25, 50]
   kizuna["R"] = [100, 200]
   kizuna["SR"] = [250, 500]
   kizuna["SSR"] = [375, 750]
   kizuna["UR"] = [500, 1000]
   unitgradechr = [[],
                  ["星空凛","西木野真姫","小泉花陽","津島善子","国木田花丸","黒澤ルビィ"],
                  ["高坂穂乃果","南ことり","園田海未","高海千歌","桜内梨子","渡辺曜"],
                  ["絢瀬絵里","東條希","矢澤にこ","松浦果南","黒澤ダイヤ","小原鞠莉"],
                  ["高坂穂乃果","絢瀬絵里","南ことり","園田海未","星空凛","西木野真姫","東條希","小泉花陽","矢澤にこ"],
                  ["高海千歌","桜内梨子","松浦果南","黒澤ダイヤ","渡辺曜","津島善子","国木田花丸","小原鞠莉","黒澤ルビィ"],
                  ["高坂穂乃果","南ことり","小泉花陽"],
                  ["園田海未","星空凛","東條希"],
                  ["絢瀬絵里","西木野真姫","矢澤にこ"],
                  ["高海千歌","渡辺曜","黒澤ルビィ"],
                  ["松浦果南","黒澤ダイヤ","国木田花丸"],
                  ["桜内梨子","津島善子","小原鞠莉"]]


   var member = ['','1年生','2年生','3年生',"μ's",'Aqours','Printemps','lilywhite','BiBi','CYaRon!','AZALEA','Guilty Kiss']

   LLCardData.briefKeys.push('minslot');
   var defer_onload = $.Deferred();
   var comp_skill = 0;

   $.when(LLCardData.getAllBriefData(), defer_onload).then(function (cardData) {
      llcard = new LLCard(cardData);
      comp_skill = new LLSkillContainer();
      init();
      document.getElementById('cardchoice').options[0].innerHTML = '';
      document.getElementById('loadingbox').style.display = 'none';
   }, defaultHandleFailedRequest);

	attr = new Array();//↓成员属性值*0
	HN = new Array();//每张卡的槽数//↓z0
	grade = new Array();//↓每个成员的年级*
	Match_c = new Array(0,0,0,0,0,0,0,0,0);//是否满足副c
	skillP = new Array();//z
	skind = new Array();//z0
	var Precal=false;
	comb=[];
	arms=new Array();//√
	P_up=new Array();//每个成员的对应宝石贡献属性增值
	P_sum = 0;
	Sum_Max_Mem=0;
	MPM=new Array();
	Team_Method=[];
	Current_MP=0;
	IsPrecalced=false;
	gradecount=new Array();
	skillcount=new Array();
	SNum = new Array();//↓每种宝石的数量*z0
   songweight=new Array();
   songweightsort=new Array()

   function threetonumber(three){
      var result = three
      if (result == '0') {
         return 0;
      }
      if (result[0] == '0') {
         result = result[1]+result[2]
      }
      if (result[0] == '0') {
         result = result[1]
      }
      return result
   }

   naipan = 480
   function changenaipan(){
      if (!document.getElementById('naipan').checked)
         naipan = 480
      else
         naipan = 270
   }

   pos = -1
   function savesubmemberNO(i){
		sublength=submember.length
		submember[sublength]={}
		var savesublist=['cardid','mezame','main','smile','pure','cool','skilllevel','maxcost']
		for(var j in savesublist)
			submember[sublength][savesublist[j]]=submember[i][savesublist[j]]
   }
   function changepos(i){
      if (pos==-1){
         document.getElementById('pos'+String(i)).value = '选择' 
         pos = i
      }
      else{
         document.getElementById('pos'+String(pos)).value = '换位'+String(pos+1)
         swaplist = ['cardid','mezame','main','smile','pure','cool','skilllevel','gemnum','gemsinglepercent','gemallpercent','gemskill','gemacc','maxcost']
		 if(i>8 && pos>8){
			var swapsubmemberlist = ['cardid','mezame','main','smile','pure','cool','skilllevel','maxcost']
			savesubmemberNO(i-9)
			for(var j in swapsubmemberlist){
				submember[i-9][swapsubmemberlist[j]]=submember[pos-9][swapsubmemberlist[j]]
				submember[pos-9][swapsubmemberlist[j]]=submember[sublength][swapsubmemberlist[j]]
			}
			submember.splice(sublength,1)
			refreshsubmemberlist()
		 }
		 else if(i>8 && pos<=8){
			savesubmemberNO(i-9)
			arrageunitmembertosub(pos,i-9)
			arragesubmembertounit(sublength,pos)
			submember.splice(sublength,1)
			if(submember[i-9]['cardid']=="0") submember.splice(i-9,1)
			refreshsubmemberlist()
		 }
		 else if(i<=8 && pos>8){
			savesubmemberNO(pos-9)
			arrageunitmembertosub(i,pos-9)
			arragesubmembertounit(sublength,i)
			submember.splice(sublength,1)
			if(submember[pos-9]['cardid']=="0") submember.splice(pos-9,1)
			refreshsubmemberlist()
		 }
		 else {
         for (j in swaplist){
            at = swaplist[j]
            tmp = document.getElementById(at+String(pos)).value
            document.getElementById(at+String(pos)).value = document.getElementById(at+String(i)).value
            document.getElementById(at+String(i)).value = tmp
         } 
		calslot(pos)
		calslot(i)
		LLUnit.changeavatarn(pos)
         LLUnit.changeavatarn(i)
		}
         
		 if(pos==4 || i==4) LLUnit.changecenter()
         pos = -1 
      }
   }

   function changemapcolor(attr) {
      if (attr === undefined) attr = document.getElementById('map').value;
      // do not update base, secondbase, bonus, because they are set by center
      document.getElementById('map').style.color = llsong.attcolor[attr];
      if (attr == llsong.getSongAttr()) document.getElementById('songchoice').style.color = llsong.attcolor[attr];
      document.getElementById('secondbase2').innerHTML = attr;
      if (document.getElementById("percentage2").value != 12) document.getElementById('base2').value = attr;
      document.getElementById('bonus2').value = attr;
   }

   function applysongdata() {
      var handleTime = function(t) { document.getElementById("time").value = (t ? t : 110); };
      var handlePerfect = function(combo) { document.getElementById("perfect").value = parseInt(combo*19/20); };
      var handleStar = function() { document.getElementById("starperfect").value = 0; };
      var handleWeight = function(w) { for (var i = 0; i < 9; i++) { document.getElementById("weight"+i).value = parseFloat(w[i]); } };
      var applyTarget = {
         'attribute': ['map', changemapcolor],
         'combo': ['combo', handlePerfect],
         'time': [handleTime],
         'star': [handleStar],
         'positionweight': [handleWeight]
      };
      llsong.applyDataOfSongWithDiff(applyTarget);
   }

   function calslot(n){
      result = 0
      result += parseInt(parseInt(document.getElementById("gemnum"+String(n)).value)/200)
      result +=  parseInt(parseFloat(document.getElementById("gemsinglepercent"+String(n)).value)/0.05)
      result +=  parseInt(parseFloat(document.getElementById("gemallpercent"+String(n)).value)/0.0059)
      result += parseInt(parseInt(document.getElementById("gemskill"+String(n)).value)*4)
      result += parseInt(parseInt(document.getElementById("gemacc"+String(n)).value)*4)
      document.getElementById("slot"+String(n)).innerHTML = result
   }

   function changeLanguage(){
      language = 1-language
      llsong.language = language;
      llsong.onSongFilterChange();
      llcard.language = language;
      llcard.onCardFilterChange();
   }
   
   function toMezame(){
   	mezame = 1-mezame
      LLUnit.applycarddata();
   }


   function clearall(){
   	var inputs = document.getElementsByTagName("input");
   	var selects = document.getElementsByTagName("select");
   	for (var i=0; i<inputs.length; i++){
   		setCookie(inputs[i].name+"unit", inputs[i].value, -1);
   	}
   	for (var i=0; i<selects.length; i++){
   		setCookie(selects[i].name+"unit", selects[i].value, -1);
   	}
   	setCookie("mezame"+"unit", mezame, -1)
   	window.location.href="/llnewautounit"
	refreshsubmemberlist()
   }
   function savesis(){
	sisstore={}
	for(i=1;i<16;i++){
		sisstore[i]=document.getElementById('sis'+String(i)).value
	}
	unitjson = JSON.stringify(sisstore)
   	window.location.href="/llsavesis/"+unitjson
   }
   function saveunit(){
   	member = [{}, {}, {},{},{},{},{},{},{},{}]
   	saveatt = ['smile', 'pure', 'cool', 'skilllevel', 'cardid', 'mezame', 'gemnum', 'gemsinglepercent', 'gemallpercent', 'gemskill', 'gemacc','maxcost']
   	for (i=0;i<9;i++){
   		for (j in saveatt){
   			member[i][saveatt[j]] = document.getElementById(saveatt[j]+String(i)).value
   		}
   	}
	for(i=1;i<16;i++){
		member[9][i]=document.getElementById('sis'+String(i)).value
	}
   	unitjson = JSON.stringify(member)
   	window.location.href="/llsaveunit/"+unitjson
   }
   function savesubmembers(){
	var submemberlist=[]
	savesubmemberatt=['cardid','mezame','skilllevel','maxcost']
	for(var i in submember){
		submemberlist[i]={}
		for(j in savesubmemberatt){
			submemberlist[i][savesubmemberatt[j]]=String(submember[i][savesubmemberatt[j]])
			}
	}
	submembersjson=JSON.stringify(submemberlist)
	window.location.href="/llsavesubmembers/"+submembersjson
   }
   function saveallmembers(){
	var submemberlist=[]
	savesubmemberatt=['cardid','mezame','skilllevel','maxcost']
	for (i=0;i<9;i++){
		submemberlist[i]={}
   		for (j in savesubmemberatt){
   			submemberlist[i][savesubmemberatt[j]] = document.getElementById(savesubmemberatt[j]+String(i)).value
   		}
   	}
	for(var i=0;i<submember.length;i++){
		submemberlist[i+9]={}
		for(j in savesubmemberatt){
			submemberlist[i+9][savesubmemberatt[j]]=String(submember[i][savesubmemberatt[j]])
			}
	}
	
	submembersjson=JSON.stringify(submemberlist)
	window.location.href="/llsaveallmembers/"+submembersjson
   }
   var tmponsubmit
   function loadsubmembers(){
      document.getElementById("unitform").action = '/llloadex/filesub/parent.handleLoadSubmembersData'
//   	tmponsubmit = document.getElementById("unitform").onsubmit
   	document.getElementById("unitform").onsubmit = ''
   	document.getElementById("unitform").target = 'if'
   }

   function handleLoadSis(sis) {
      if (sis && Object.keys(sis).length == 15) {
         for (var i = 1; i < 16; i++) {
            if (sis[i]) {
               sisrecord[i] = sis[i];
            } else {
               sisrecord[i] = 0;
            }
         }
         autoarm();
      }
   }
   function handleLoadUnit(unit) {
      var attlist = ['smile', 'pure', 'cool', 'skilllevel', 'cardid', 'mezame', 'gemnum', 'gemsinglepercent', 'gemallpercent', 'gemskill', 'gemacc', 'maxcost'];
      for (var i = 0; i < 9; i++) {
         var member = unit[i];
         for (var j in attlist) {
            var att = attlist[j];
            var value = 0;
            if (member && member[att] !== undefined) value = member[att];
            document.getElementById(att + i).value = value;
         }
         if (member && member.cardid) {
            document.getElementById("main" + i).value = llcard.cards[member.cardid].attribute;
         }
         LLUnit.changeavatarn(i);
         calslot(i);
      }
      LLUnit.changecenter();
      precalcu();
      handleLoadSis(unit[9]);
   }

   function loadunit(){
      document.getElementById("unitform").action = '/llload/parent.handleLoadUnit'
   	tmponsubmit = document.getElementById("unitform").onsubmit
   	document.getElementById("unitform").onsubmit = ''
   	document.getElementById("unitform").target = 'if'
   }
   function precalcu(){
   	document.getElementById("unitform").action = ''
   	document.getElementById("unitform").onsubmit = tmponsubmit
   	document.getElementById("unitform").target = ''
   }
   function loadsis(){
	document.getElementById("unitform").action = '/llloadex/filesis/parent.handleLoadSis'
//   	tmponsubmit = document.getElementById("unitform").onsubmit
   	document.getElementById("unitform").onsubmit = ''
   	document.getElementById("unitform").target = 'if'
   }
   function init(){
   	//document.getElementById('avatar0').src = 'http://i2.tietuku.com/8baa9a87cc083022.jpg'
   	mezame = getCookie("mezameunit")
   	language = getCookie("languageunit")
      if (mezame == "") mezame = 0; else mezame = parseInt(mezame);
   	if (language == "")
   		language = 0
   	
      llsong.language = language;
      llsong.onDiffSelectChange = applysongdata;
      llsong.showAllSongs();
      llsong.initListeners();
      llsong.initAttrSelectColor('map');

      llcard.language = language;
      llcard.onCardSelectChange = LLUnit.applycarddata;
      llcard.showAllCards();
      llcard.initListeners();

   	var inputs = document.getElementsByTagName("input");
   	var selects = document.getElementsByTagName("select");
   	for (var i=0; i<inputs.length; i++){
   		if (inputs[i].type == "text")
   			if (getCookie(inputs[i].name+"unit") != "")
   				inputs[i].value = getCookie(inputs[i].name+"unit");
   	}
   	for (var i=0; i<selects.length; i++){
   		if (getCookie(selects[i].name+"unit") != "")
   			selects[i].value = getCookie(selects[i].name+"unit");
   	}
      document.getElementById("mezame").checked = mezame
   	for (i = 0; i < 9; i++){
   		LLUnit.changeavatarn(i)
         calslot(i)
   	}
      document.getElementById("songsearch").value = ""
      // above codes may select songs/cards/filters according to cookies, so refresh it...
      llsong.onSongFilterChange();
      llcard.onCardFilterChange();
	document.getElementById("submembersoperation").style.display="none"
   }
   
   
   function saveToCookie(){
   	var inputs = document.getElementsByTagName("input");
   	var selects = document.getElementsByTagName("select");
   	for (var i=0; i<inputs.length; i++){
   		if (inputs[i].type == "text")
   			setCookie(inputs[i].name+"unit", inputs[i].value, 1);
   	}
   	for (var i=0; i<selects.length; i++){
   		setCookie(selects[i].name+"unit", selects[i].value, 1);
   	}
   	setCookie("mezame"+"unit", mezame, 1)
   	setCookie("language"+"unit", language, 1)
   }
   //////////
   submember=new Array();
	function addselectsub(){
		var cardid=document.getElementById("cardchoice").value;
		var subunit={}
		if ((cardid != 0) && (cardid != "") && (cardid != "0")){
			subunit["main"]=document.getElementById("main").value
			subunit["smile"]=parseInt(document.getElementById("smile").value)
			subunit["pure"]=parseInt(document.getElementById("pure").value)
			subunit["cool"]=parseInt(document.getElementById("cool").value)
			subunit[subunit["main"]]+=parseInt(document.getElementById("kizuna").value)
		subunit["skilllevel"]=comp_skill.skillLevel+1;
		subunit["mezame"]=parseInt(mezame)
		subunit["cardid"]=cardid;
		subunit["maxcost"]=llcard.cards[cardid].minslot;
		submember.push(subunit)
		refreshsubmemberlist()
	}
   }
   function handleLoadSubmembersData(data) {
      var requests = [];
      for (var i = 0; i < data.length; i++) {
         if (Object.keys(data[i]).length == 15) continue;
         (function(index){
            // data has: 'cardid','mezame','skilllevel','maxcost'
            var cur = data[index];
            if ((!cur.maxcost) || (!cur.main)) {
               requests.push(LLCardData.getDetailedData(cur.cardid).then(function (card) {
                  if (!cur.maxcost) cur.maxcost = card.minslot;
                  if (!cur.main) {
                     cur.main = card.attribute;
                     cur.smile = card.smile2;
                     cur.pure = card.pure2;
                     cur.cool = card.cool2;
                     cur[cur.main] += kizuna[card.rarity][cur.mezame];
                  }
                  submember[index] = cur;
               }));
            } else {
               submember[index] = cur;
            }
         })(i);
      }
      LoadingUtil.start(requests).then(function () {
         refreshsubmemberlist();
      }, defaultHandleFailedRequest);
   }
   function refreshsubmemberlist(){
	//	submemberhtml="<h3>备选队员</h3>"
		if(submember.length>0) document.getElementById("submembersoperation").style.display="block"
		else document.getElementById("submembersoperation").style.display="none"
		submemberhtml="<table border='1' style='text-align:center'>"
		for(var j=0;j<submember.length;j++){
			submemberhtml+="<td>"+'<div id='+"sublist"+String(j)+'></div>'+"</td>"
		}
		document.getElementById("submembers").innerHTML=submemberhtml
		for(var j=0;j<submember.length;j++){
			var subunithtml;
			subunithtml="<table border='1' style='text-align:center'><td><img src="+getimagepath(submember[j]["cardid"],'avatar',parseInt(submember[j]["mezame"]))+"></td></tr>"
			subunithtml+="<td>"+'等级'+'<input type="text" id="submemlv'+String(j)+'" size="3" value="'+String(submember[j]["skilllevel"])+'" onkeyup="changesublv('+j+')">'+"</td></tr>"
			subunithtml+="<td>"+'槽数'+'<input type="text" id="submemslot'+String(j)+'" size="3" value='+String(submember[j]["maxcost"])+' onkeyup="changesubslot('+j+')">'+"</td></tr>"
			subunithtml+="<td>"+'<input type="button" onclick="Delsubmem('+j+')" value="删除" />'+'<input type="button" id=pos'+String(j+9)+' onclick="changepos('+String(j+9)+')" value="换位" />'+"</td>"
			document.getElementById("sublist"+String(j)).innerHTML=subunithtml
		}
   }
function Delsubmem(j){
	//删除submember中某元素
	var sublisthtml;
	submember.splice(j,1)
	refreshsubmemberlist()
}
function changesublv(n){
	submember[n]["skilllevel"]=parseInt(document.getElementById("submemlv"+String(n)).value)
}
function changesubslot(n){
	submember[n]["maxcost"]=parseInt(document.getElementById("submemslot"+String(n)).value)
}
   ///////////
sisrecord=new Array(9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9);
   function autoarm(){
	if(document.getElementById('autoarm0').checked){
		if(IsPrecalced==false){
//   if(IsPrecalced==false){
			sishtml = "<table border='1' style='text-align:center'><tr><td>通用技能</td><td>香水（ 450 ）</td><td>光环（ 1.8% ）</td><td>面纱（ 2.4% ）</td></tr>"
			sishtml+="</tr>"
			sishtml+="<td id=chubei"+">"+'储备数量'+"</td>"
			sishtml+="<td id=si1"+">"+'<input type="text" id="sis1" name="kissnum" size="5" value="0" />'+"</td>"
			sishtml+="<td id=si8"+">"+'<input type="text" id="sis8" name="purfumenum" size="5" value="0" />'+"</td>"
			sishtml+="<td id=si9"+">"+'<input type="text" id="sis9" name="ringnum" size="5" value="0" />'+"</td>"
			sishtml+="</tr>"
			sishtml+="<table border='1' style='text-align:center'><tr><td>10%技能</td><td>指环（一年级）</td><td>指环（二年级）</td><td>指环（三年级）</td></tr>"
			sishtml+="</tr>"
			sishtml+="<td id=chubei"+">"+'储备数量'+"</td>"
			sishtml+="<td id=si2"+">"+'<input type="text" id="sis2" name="Scharm" size="5" value="0" />'+"</td>"
			sishtml+="<td id=si3"+">"+'<input type="text" id="sis3" name="Pcharm" size="5" value="0" />'+"</td>"
			sishtml+="<td id=si4"+">"+'<input type="text" id="sis4" name="Ccharm" size="5" value="0" />'+"</td>"
			sishtml+="</tr>"
			sishtml+="<table border='1' style='text-align:center'><tr><td>16%技能</td><td>十字（一年级）</td><td>十字（二年级）</td><td>十字（三年级）</td></tr>"
			sishtml+="</tr>"
			sishtml+="<td id=chubei"+">"+'储备数量'+"</td>"
			sishtml+="<td id=si5"+">"+'<input type="text" id="sis5" name="Scharm" size="5" value="0" />'+"</td>"
			sishtml+="<td id=si6"+">"+'<input type="text" id="sis6" name="Pcharm" size="5" value="0" />'+"</td>"
			sishtml+="<td id=si7"+">"+'<input type="text" id="sis7" name="Ccharm" size="5" value="0" />'+"</td>"
			sishtml+="</tr>"
			sishtml+="<table border='1' style='text-align:center'><tr><td>加分 2.5</td><td>公主魅力（红）</td><td>天使魅力（绿）</td><td>皇后魅力（蓝）</td></tr>"
			sishtml+="</tr>"
			sishtml+="<td id=chubei"+">"+'储备数量'+"</td>"
			sishtml+="<td id=si10"+">"+'<input type="text" id="sis10" name="Scharm" size="5" value="0" />'+"</td>"
			sishtml+="<td id=si11"+">"+'<input type="text" id="sis11" name="Pcharm" size="5" value="0" />'+"</td>"
			sishtml+="<td id=si12"+">"+'<input type="text" id="sis12" name="Ccharm" size="5" value="0" />'+"</td>"
			sishtml+="</tr>"
			sishtml+="<table border='1' style='text-align:center'><tr><td>体力 480</td><td>公主治愈（红）</td><td>天使治愈（绿）</td><td>皇后治愈（蓝）</td></tr>"
			sishtml+="</tr>"
			sishtml+="<td id=chubei"+">"+'储备数量'+"</td>"
			sishtml+="<td id=si13"+">"+'<input type="text" id="sis13" name="Scharm" size="5" value="0" />'+"</td>"
			sishtml+="<td id=si14"+">"+'<input type="text" id="sis14" name="Pcharm" size="5" value="0" />'+"</td>"
			sishtml+="<td id=si15"+">"+'<input type="text" id="sis15" name="Ccharm" size="5" value="0" />'+"</td>"
			sishtml+="</table>"
			sishtml+='<input type="button" onclick="savesis()" value="保存仓库" />'
			sishtml+='<input type="file" name="filesis">'
			sishtml+='<input type="submit" value="读取仓库" onclick="loadsis()">'
			document.getElementById("sisreserves").innerHTML=sishtml
//   document.getElementById("autoarm0").value = '自动装填'
			calc_arms();
			IsPrecalced=true;
		}
		else{
			document.getElementById("sisreserves").innerHTML=sishtml
		}
		for(var i=1;i<16;i++){
				document.getElementById("sis"+String(i)).value=sisrecord[i];
			}
	}
	else{
		for(var i=1;i<16;i++){
			sisrecord[i]=document.getElementById("sis"+String(i)).value;
		}
		document.getElementById("sisreserves").innerHTML=" ";
 //  stararm()
//   document.getElementById("test00").value =document.getElementById("kissnum").value
	}
   }
   ////////
   function Sis_get_Data(){
	//获取主唱
	var Psong=document.getElementById("map").value;
	for(var i=0;i<9;i++){
		attr[i]=parseInt(document.getElementById(Psong+String(i)).value);
		HN[i]=parseInt(document.getElementById("maxcost"+String(i)).value);
		if(HN[i]>8){
			HN[i]=8;
			document.getElementById("maxcost"+String(i)).value="8";
		}
		if(HN[i]<=0){
			HN[i]=1;
			document.getElementById("maxcost"+String(i)).value="1";
		}
	}
	SNum[0]=9;
	for(var i=1;i<16;i++){
		SNum[i]=parseInt(document.getElementById("sis"+i.toString()).value);
		if(SNum[i]>9) SNum[i]=9;
		if(SNum[i]<0) SNum[i]=0;
		}
	for(var i=0;i<9;i++){
//		skillP[i]=parseInt(document.getElementById("skillstrength"+String(i)).value);
		if(skind[i]<3) skillP[i]=skillP[i]*3/5;
	}
	}
	//////////////////////*******************
	cost = new Array( 1,2,2,3,3,4,4 );

function arm_sis(mp,mc,Mem) {
	var s = mp.split('');
	var p = Team_Method[Mem][mp].strength;
	for (var x in comb[mc]) {//确定要扣哪一个宝石
		var xx=0;
		if (comb[mc][x] < 2) xx = comb[mc][x];
		if (comb[mc][x] == 2) xx = grade[Mem] + 1;
		if (comb[mc][x] == 3) xx = grade[Mem] + 4;
		if (comb[mc][x] == 4 || comb[mc][x] == 5) xx = comb[mc][x] + 4;
		if (comb[mc][x] == 6) xx = skind[Mem] + 10;
		if((comb[mc][x] == 6) && skind[Mem]==6) return false;
		if (s[xx] == '-') {
			p += P_up[Mem][comb[mc][x]];
		}
		if (s[xx] > '0'&&s[xx]<'9') {
			s[xx] -= 1;
			p += P_up[Mem][comb[mc][x]];
		}
		else if (s[xx] == '0') return false;
	}
	for (ii = 0; ii < 16; ii++) {
		if ((s[ii] != '-') && ((s[ii] - '0') >= (8 - Mem))) {
			s[ii] = '-';
		}
	}
	if((s[grade[Mem]+1]-'0')>=(gradecount[grade[Mem]-1]-1)) s[grade[Mem]+1]='-';
	if((s[grade[Mem]+4]-'0')>=(gradecount[grade[Mem]-1]-1)) s[grade[Mem]+4]='-';
	if(skind[Mem]<6){
		if((s[skind[Mem]+10]-'0')>=(skillcount[skind[Mem]]-1)) s[skind[Mem]+10]='-';
	}
	s=s.join('');
	if(typeof Team_Method[Mem+1][s]=== 'undefined'){
		Team_Method[Mem+1][s]={strength:p,premethod:mp,currmethod:mc};
	}
	else{
		if(Team_Method[Mem+1][s].strength<p){
			Team_Method[Mem+1][s]={strength:p,premethod:mp,currmethod:mc};
		}
	}
	if (p > Current_MP) Current_MP = p;
	return true;
}
function calc_arms(){
	arms[0]=0;
	for (i = 1; i < 9; i++) {
		arms[i]=new Array();
		arms[i][0]=0;
		for (j = 1; j < 128; j++) {
			var m = 0;
			var sc = 0;
			var x = j;
			var sv=new Array();
			while (x >= 1) {
				sc += (x % 2)*cost[m];
				if (x % 2 == 1) sv.push(m);
				x = parseInt(x/2);
				m++;
			}
			if(sc<i && ((j%2)==0)) continue;
			if (sc <= i) {
				if(typeof comb[j]=== 'undefined')
					comb[j]=sv;
				arms[i].push(j);
			}
		}
	}
}
function P_Matrix(){
	var P_sumtri=0;
	var P_sumfor=0;
	for (i = 0; i < 9; i++){
		pa=Math.ceil(attr[i]*0.018);
		pa=Math.ceil(pa*(1 + Match_c[i]));
		pb=Math.ceil(attr[i]*0.024);
		pb=Math.ceil(pb*(1 + Match_c[i]));
		P_sumtri+=pa;
		P_sumfor+=pb;
		}
	for (i = 0; i < 9; i++) {
		P_up[i]=new Array();
		P_up[i][0] = 200 * (1.0 + Match_c[i]);
		P_up[i][1] = 450 * (1.0 + Match_c[i]);
		P_up[i][2] = 0.1*(1.0 + Match_c[i])*attr[i];
		P_up[i][3] = 0.16*(1.0  + Match_c[i])*attr[i];
		P_up[i][4] = P_sumtri;
		P_up[i][5] = P_sumfor;
		P_up[i][6] = skillP[i]/additionrate;
	}//书写宝石强度加成矩阵
}
function calc_MPM() {
	for (i = 0; i < 9; i++) {
		var MPi = 0;
		for (var j in arms[HN[i]]) {
			var p=0;
			for (var x in comb[arms[HN[i]][j]]) {
				p += P_up[i][comb[arms[HN[i]][j]][x]];
			}
			if (MPi < p) MPi = p;
		}
		MPM[i] = MPi;
		Sum_Max_Mem += MPi;
	}
}


function calc_bestarm(){
	for(var i=0;i<9;i++){
		gradecount[grade[i]-1]++;
		skillcount[skind[i]]++;
		}
	//递归开始
	
	var o_sis=new Array();
	o_sis[0]='-';
	for (i = 1; i < 16; i++) {
		if (SNum[i] >= 9) o_sis[i] = '-';
		else o_sis[i] = SNum[i];
	}
	for(i=0;i<3;i++){
	if(SNum[i+2]>=gradecount[i]) o_sis[i+2] = '-';
	if(SNum[i+5]>=gradecount[i]) o_sis[i+5] = '-';
	}
	for(i=0;i<6;i++){
	if(SNum[i+10]>skillcount[i]) o_sis[i+10] = '-';
	}
	o_sis=o_sis.join('');
	Team_Method[0]=[];
	Team_Method[0][o_sis]={strength:0,premethod:"",currmethod:0};
	
	for (i = 1; i < 10; i++) {
		Team_Method[i]=[];
		for(mp in Team_Method[i - 1]){
			if ((Current_MP - Team_Method[i - 1][mp].strength) > Sum_Max_Mem) continue;//
			var smp = mp.split('');
			for (ii = 0; ii<16; ii++) {
				if ((smp[ii] != '-') && ((smp[ii] - '0') >= (9 - i)))
					smp[ii] = '-';
			}
			if((smp[grade[i-1]+1]-'0')>=(gradecount[grade[i-1]-1]-1)) smp[grade[i-1]+1]='-';
			if((smp[grade[i-1]+4]-'0')>=(gradecount[grade[i-1]-1]-1)) smp[grade[i-1]+4]='-';
			if(skind[i-1]<6){
				if((smp[skind[i-1]+10]-'0')>=(skillcount[skind[i-1]]-1)) smp[skind[i-1]+10]='-';
			}
			smp=smp.join('');
			if(typeof Team_Method[i][smp]=== 'undefined'){
				Team_Method[i][smp]={strength:Team_Method[i-1][mp].strength,premethod:mp,currmethod:0};
				}
			else if(Team_Method[i][smp].strength<Team_Method[i-1][mp].strength){
				Team_Method[i][smp]={strength:Team_Method[i-1][mp].strength,premethod:mp,currmethod:0};
			}
			for(var mc in arms[HN[i - 1]]){//当前配石方案下计算每一列 mc配石方案标号 mp已有配石所剩余石头标号 
				arm_sis(mp, arms[HN[i - 1]][mc], i - 1);
			}
		}
		Sum_Max_Mem -= MPM[i - 1];
		gradecount[grade[i-1]-1]--;
		skillcount[skind[i-1]]--;
	}
//递归结束

	var max_p = 0;
	var max_s;
	for (mp in Team_Method[9]) {//找到最大的内个
		if (max_p < Team_Method[9][mp].strength) {
			max_p = Team_Method[9][mp].strength;
			max_s = mp;
		}
	}
	var p_s = max_s;
	for (i = 9; i > 0; i--) {
		gnx=0;
		gspx=0;
		gapx=0;
		gsx=0;
		for(x in comb[Team_Method[i][p_s].currmethod]){
			if(comb[Team_Method[i][p_s].currmethod][x]==0) gnx+=200;
			if(comb[Team_Method[i][p_s].currmethod][x]==1) gnx+=450;
			if(comb[Team_Method[i][p_s].currmethod][x]==2) gspx+=10;
			if(comb[Team_Method[i][p_s].currmethod][x]==3) gspx+=16;
			if(comb[Team_Method[i][p_s].currmethod][x]==4) gapx+=18;
			if(comb[Team_Method[i][p_s].currmethod][x]==5) gapx+=24;
			if(comb[Team_Method[i][p_s].currmethod][x]==6) gsx=1;
		}
		document.getElementById("gemnum"+String(i-1)).value=String(gnx);
		document.getElementById("gemsinglepercent"+String(i-1)).value=String(gspx/100);
		document.getElementById("gemallpercent"+String(i-1)).value=String(gapx/1000);
		document.getElementById("gemskill"+String(i-1)).value=String(gsx);
		p_s = Team_Method[i][p_s].premethod;
	}
	}
	///
	function fillunit(){
		if(submember.length<8){
			for(var i=0;i<submember.length;i++){
				if(i<4) arragesubmembertounit(i,i)
				else arragesubmembertounit(i,i+1)
			}
		}
		else for(var i=0;i<8;i++){
			if(i<4) arragesubmembertounit(i,i)
			else arragesubmembertounit(i,i+1)
		}
		submember.splice(0,8)
		refreshsubmemberlist()
	}
	function getallmembers(){
		var subcopyListstr=["main","cardid"]
		var subcopyList=["smile","pure","cool","skilllevel","mezame","maxcost"]
		for(var i=0;i<9;i++){
			if(i==4) continue;
			var subunit={}
			var cardid = threetonumber(document.getElementById('cardid'+String(i)).value)
			if ((cardid == 0) || (cardid == "") || (cardid == "0"))
				continue;
			subunit["main"]=document.getElementById("main"+String(i)).value
			subunit["cardid"]=document.getElementById("cardid"+String(i)).value
			for(var j in subcopyList)
				subunit[subcopyList[j]]=parseInt(document.getElementById(subcopyList[j]+String(i)).value)
			submember.push(subunit)
		}
		{
			var subunit={}
			var cardid = threetonumber(document.getElementById('cardid4').value)
			subunit["main"]=document.getElementById("main4").value
			subunit["cardid"]=document.getElementById("cardid4").value
			for(var j in subcopyList)
				subunit[subcopyList[j]]=parseInt(document.getElementById(subcopyList[j]+String(4)).value)
			submember.push(subunit)
		}
	}
   //计算所有加成，和最高属性
   function setsubmemAddition(){
      var mainp=document.getElementById("map").value
      var mapsong=llsong.getSelectedSong();
      for (var memi in submember) {
         groupbonus = samegroup(mapsong,llcard.cards[submember[memi]["cardid"]].jpname)
         colorbonus = (mainp == submember[memi]['main'])
         submember[memi]["addition"]=1.21
         if (!groupbonus && !colorbonus)
            submember[memi]["addition"]=1
         else if (!groupbonus || !colorbonus)
            submember[memi]["addition"]=1.1
      }
   }
	function getMaxeight(){
      var mainp=document.getElementById("map").value
		unitmembers=new Array()
		subunitmembers=new Array()
		for(var k=0;k<submember.length-1;k++){
			subunitmembers.push(k);
		}
		for(var i=0;i<8;i++){
			var maxmainp=0;
			var maxselect=0
			for(var j=0;j<subunitmembers.length;j++){
				if(maxmainp<submember[subunitmembers[j]][mainp]){
					maxmainp=submember[subunitmembers[j]][mainp]
					maxselect=j
				}
			}
			unitmembers[i]=subunitmembers[maxselect];
			subunitmembers.splice(maxselect,1);
		}
	}
	
	//先排序权重，随歌曲而动,从大到小
	
	function orderposbyweight(){
		weightsum=0;
		var songweight0=new Array()
		for(var i=0;i<9;i++){
			songweight[i]=parseFloat(document.getElementById("weight"+String(i)).value)
			songweight0[i]=songweight[i]
			weightsum+=songweight[i]
		}
		
		for(var i=0;i<8;i++){
			mweight=0
			for(var j=0;j<9;j++){
				if(j==4) continue
				if(mweight<songweight0[j]){
					mweight=songweight0[j]
					songweightsort[i]=j
				}
			}
			songweight0[songweightsort[i]]=0
		}
	}
	
	//再排序加成，随计算而动，从大到小
	function ordermembyaddition(){
		unitorder=new Array();
		var n=0;
		for(var i=0;i<8;i++){
			if(submember[unitmembers[i]]["addition"]>1.15) {
				unitorder[n]=unitmembers[i]
				n++
			}
		}
		for(var i=0;i<8;i++){
			if(submember[unitmembers[i]]["addition"]>1.05 && submember[unitmembers[i]]["addition"]<1.15) {
				unitorder[n]=unitmembers[i]
				n++
			}
		}
		for(var i=0;i<8;i++){
			if(submember[unitmembers[i]]["addition"]<1.05) {
				unitorder[n]=unitmembers[i]
				n++
			}
		}
	}
	//安排位置，随计算而动
	function arrageunitmembertosub(unitNO,subNO){
		var subcopyListstr=["main","cardid"]
		var subcopyList=["smile","pure","cool","skilllevel","mezame","maxcost"]
		for(var j in subcopyList){
			submember[subNO][subcopyList[j]]=parseInt(document.getElementById(subcopyList[j]+String(unitNO)).value)
		}
		submember[subNO]["main"]=document.getElementById("main"+String(unitNO)).value
		submember[subNO]["cardid"]=document.getElementById("cardid"+String(unitNO)).value
		refreshsubmemberlist()
	}
	function arragesubmembertounit(subNO,unitNO){
		var subcopyListstr=["main","cardid"]
		var subcopyList=["smile","pure","cool","skilllevel","mezame","maxcost"]
		for(var j in subcopyList){
			document.getElementById(subcopyList[j]+String(unitNO)).value=String(submember[subNO][subcopyList[j]])
			//var testq=document.getElementById(subcopyList[j]+String(posi)).value
		}
		document.getElementById("main"+String(unitNO)).value=submember[subNO]["main"]
		document.getElementById("cardid"+String(unitNO)).value=submember[subNO]["cardid"]
		LLUnit.changeavatarn(unitNO)
	}
	
	function arrangepos(){
		additionrate=0
		var subcopyListstr=["main","cardid"]
		var subcopyList=["smile","pure","cool","skilllevel","mezame","maxcost"]
		for(var i=0;i<8;i++){
			var posi=songweightsort[i]
			var memi=unitorder[i]
			for(var j in subcopyList){
				document.getElementById(subcopyList[j]+String(posi)).value=String(submember[memi][subcopyList[j]])
				var testq=document.getElementById(subcopyList[j]+String(posi)).value
			}
			document.getElementById("main"+String(posi)).value=submember[memi]["main"]
			document.getElementById("cardid"+String(posi)).value=submember[memi]["cardid"]
			LLUnit.changeavatarn(posi)
			additionrate+=(submember[memi]["addition"]*songweight[posi]/1.21)
			//refreshsubmemberlist();/////=========delete
		}
		additionrate+=submember[submember.length-1]["addition"]*songweight[4]/1.21
		additionrate/=weightsum
	}
	function swapmember(i,j){
		k=subunitmembers[i]
		subunitmembers[i]=unitmembers[j]
		unitmembers[j]=k
	}
	var gettotalstrength;
	function autounit(cards){
		var curtotalstrength=0;
		orderposbyweight()
		getallmembers()
		setsubmemAddition()
		getMaxeight()
		//
		ordermembyaddition()
		arrangepos()
		refreshsubmemberlist();/////////////////////===del
		autoarmforeveryunit(cards)
		calculate(cards)
		curtotalstrength=gettotalstrength;
		///////=====
		for(var i=0;i<subunitmembers.length;i++){
			var maxaddition=0;
			var replaceselect=-1;
		//	setTimeout("document.getElementById('testtime').innerHTML='<p>+String(i)+</p>'",1000)
			for(var j=0;j<8;j++){
				swapmember(i,j)
				ordermembyaddition()
				arrangepos()
				autoarmforeveryunit(cards)
				calculate(cards)
				if(maxaddition<(gettotalstrength-curtotalstrength)){
					maxaddition=(gettotalstrength-curtotalstrength)
					replaceselect=j
				}
				swapmember(i,j)
			}
			if(replaceselect!=(-1)){
				swapmember(i,replaceselect)
				curtotalstrength+=maxaddition
			}
		}
		///==========
		ordermembyaddition()
		arrangepos()
		autoarmforeveryunit(cards)
	}
   ////////*******************
   function check(){
   	var inputs = document.getElementsByTagName("input");
   	for (i in inputs){
   		if ((inputs[i].type != "text") || (inputs[i].name == "songsearch"))
   			continue
   		if (!isNumber(inputs[i].value)){
   			alert(inputs[i].value+"请输入数字");
   			return false;
   		}
   	}
   	saveToCookie();
	/////////////
      var requests = [];
      for (var i = 0; i < 9; i++) {
         var cardid = document.getElementById('cardid' + i).value;
         if (cardid) {
            requests.push(LLCardData.getDetailedData(cardid));
         }
      }
      for (var i = 0; i < submember.length; i++) {
         var cardid = submember[i].cardid;
         if (cardid) {
            requests.push(LLCardData.getDetailedData(cardid));
         }
      }
      LoadingUtil.start(requests, LoadingUtil.cardDetailMerger).then(function (cards) {
         if(document.getElementById('autoarm0').checked){
		Precal=true;
		autounit(cards)
		Precal=false;
		submember.splice(submember.length-1,1)
		var premax=submember.length
		for(var i=0;i<8;i++){
			var maxmemnum=0
			for(var j in unitmembers){
				if(maxmemnum<unitmembers[j] && unitmembers[j]<premax)
					maxmemnum=unitmembers[j]
			}
			submember.splice(maxmemnum,1)
			premax=maxmemnum
		}
		for(var i=0;i<9;i++)
			LLUnit.changeavatarn(i)
		refreshsubmemberlist()
         }
         /////////////////////
         calculate(cards);
         document.getElementById("result").scrollIntoView()
      }, defaultHandleFailedRequest);
      return true;
   }
   function autoarmforeveryunit(cards){
		Sum_Max_Mem=0;//-
		Current_MP=0;//-
		Team_Method=[];//-
		for(var i=0;i<9;i++){
			document.getElementById("gemskill"+String(i)).value="1";
			Match_c[i]=0;
		}
		for(var i=0;i<3;i++) gradecount[i]=0;
		for(var i=0;i<6;i++) skillcount[i]=0;
		calculate(cards);
		Sis_get_Data();
		P_Matrix();
		calc_MPM();
		calc_bestarm();
	}
   function cbmulti(cb) {
      if (cb <= 50) {
         return 1;
      } else if (cb <= 100) {
         return 1.1 - 5 / cb;
      } else if (cb <= 200) {
         return 1.15 - 10 / cb;
      } else if (cb <= 400) {
         return 1.2 - 20 / cb;
      } else if (cb <= 600) {
         return 1.25 - 40 / cb;
      } else if (cb <= 800) {
         return 1.3 - 70 / cb;
      } else {
         return 1.35 - 110 / cb;
      }
   }

   function addskill(dist, score, prob, minscore) {
      var newdist = [];
      var q = 1 - prob;
      var i = 0;
      for (; i < dist.length && dist[i][0] < minscore; i++) {
         newdist.push(dist[i]);
      }
      if (i < dist.length) {
         var j = i;
         for (;;) {
            if (dist[i][0] < dist[j][0] + score) {
               newdist.push([dist[i][0], dist[i][1] * q]);
               if (++i >= dist.length) {
                  break;
               }
            } else if (dist[i][0] > dist[j][0] + score) {
               newdist.push([dist[j][0] + score, dist[j][1] * prob]);
               ++j;
            } else {
               newdist.push([dist[i][0], dist[i][1] * q + dist[j][1] * prob]);
               ++j;
               if (++i >= dist.length) {
                  break;
               }
            }
         }
         for (; j < dist.length; j++) {
            newdist.push([dist[j][0] + score, dist[j][1] * prob]);
         }
      }
      return newdist;
   }

   function samegroup(song, jpname){
      if (song['muse'] == 1)
         for (i in unitgradechr[4])
            if (jpname == unitgradechr[4][i])
               return true
      if (song['aqours'] == 1)
         for (i in unitgradechr[5])
            if (jpname == unitgradechr[5][i])
               return true
      return false
   }

   function strengthdetail(i){
    tail = tail || 0
    basic = 0
    if (c.support == 1)
      return 0
    if (c.Cskillpercentage < 12){
      if (mezame == 0)
        basic = parseInt(c[c.attribute]*1.09)+kizuna[c.rarity][0]
      else
        basic = parseInt(c[c.attribute+'2']*1.09)+kizuna[c.rarity][1]
    }
    else{
      if (mezame == 0)
        basic = parseInt(c[c.attribute])+parseInt(c[c.Cskillattribute]*0.12)+kizuna[c.rarity][0]
      else
        basic = parseInt(c[c.attribute+'2'])+parseInt(c[c.Cskillattribute+'2']*0.12)+kizuna[c.rarity][1]
    }
    if (!c.skill)
      return basic
    skill = 0
    if (c.skilleffect == 11)
      skill = skillstrength(c, level, combo, longrate, perfectrate, time, starperfect)
    return basic+skill
   }

   function calculate(cards) {
      var result = {};
      var int_element = ["cardid", "smile", "pure", "cool", "skilllevel", 'gemnum', 'gemskill', 'gemacc'];
      var float_element = ["weight",'gemsinglepercent','gemallpercent'];
      var sel_element = ['base', 'base2', 'bonus', 'bonus2', 'map'];
      var sel_int = ['percentage', 'percentage2', 'secondlimit', 'secondlimit2', 'secondpercentage', 'secondpercentage2', 'combo', 'perfect', 'starperfect', 'time', 'skillup', 'tapup'];
      var sel_float = [];
      var atts = ['smile', 'pure', 'cool'];
      var member = [{}, {}, {}, {}, {}, {}, {}, {}, {}];
      var mapcenter = {};
      result['baseatt'] = {};
      result['bonusatt'] = {};
      mapcenter['secondbase'] = document.getElementById('map').value
      mapcenter['secondbase2'] = document.getElementById('map').value
      for (var i = 0; i < atts.length; i++) {
         result['baseatt'][atts[i]] = 0;
         result['bonusatt'][atts[i]] = 0;
      }
      for (var i = 0; i < sel_int.length; i++) {
         mapcenter[sel_int[i]] = parseInt(document.getElementById(sel_int[i]).value);
      }
      for (var i = 0; i < sel_float.length; i++) {
         mapcenter[sel_float[i]] = parseFloat(document.getElementById(sel_float[i]).value);
      }
      for (var i = 0; i < sel_element.length; i++) {
         mapcenter[sel_element[i]] = document.getElementById(sel_element[i]).value;
      }
      for (var i = 0; i < 9; i++) {
         for (var j = 0; j < int_element.length; j++) {
            member[i][int_element[j]] = parseInt(document.getElementById(int_element[j] + i.toString()).value);
         }
		//  if(Precal)  member[i]['gemskill']=1; 
         for (var j = 0; j < float_element.length; j++) {
            member[i][float_element[j]] = parseFloat(document.getElementById(float_element[j] + i.toString()).value);
         }
         member[i]["main"] = document.getElementById("main" + i.toString()).value;
         member[i]["skill"] = LLUnit.cardtoskilltype(cards[member[i]["cardid"]])
	 if((member[i]["skill"]==1) || (member[i]["skill"]==2) ||(member[i]["skill"]==3) ||(member[i]["skill"]==4) ||(member[i]["skill"]==10) ||(member[i]["skill"]==11)){
		if(member[i]["main"]=="smile") skind[i]=0;
		if(member[i]["main"]=="pure") skind[i]=1;
		if(member[i]["main"]=="cool") skind[i]=2;
	}
	else if(member[i]["skill"]==7 || member[i]["skill"]==8 ||member[i]["skill"]==9 ||member[i]["skill"]==13){
		if(member[i]["main"]=="smile") skind[i]=3;
		if(member[i]["main"]=="pure") skind[i]=4;
		if(member[i]["main"]=="cool") skind[i]=5;
	}
	else skind[i]=6;
         member[i]["require"] = cards[member[i]["cardid"]]['skilldetail'][member[i]['skilllevel']-1].require
         member[i]["possibility"] = cards[member[i]["cardid"]]['skilldetail'][member[i]['skilllevel']-1].possibility
         member[i]["score"] = cards[member[i]["cardid"]]['skilldetail'][member[i]['skilllevel']-1].score
         sk = member[i]["skill"]
         if ((sk == 1) || (sk == 2) || (sk == 3) || (sk == 4) || (sk == 11)|| (sk == 10)){
            member[i]["score"] *= (1+1.5*parseInt(member[i]['gemskill']))
            member[i]["score"] = Math.ceil(member[i]["score"])
         } else if ((sk == 5) || (sk == 6) || (sk == 12)) {
            member[i]["score"] = cards[member[i]["cardid"]]['skilldetail'][member[i]['skilllevel']-1].time
         }
         for (var j = 0; j < atts.length; j++) {
            result['baseatt'][atts[j]] += member[i][atts[j]];
         }
      }

      mainatt = mapcenter['map']
      rawmainatt = result['baseatt'][mainatt]

      rawmember = [0,0,0,0,0,0,0,0,0]
      attst = [0,0,0,0,0,0,0,0,0]
      for (var i = 0; i < 9; i++) {
         tmp = new Array()
         tmp['smile'] = member[i]['smile']
         tmp['pure'] = member[i]['pure']
         tmp['cool'] = member[i]['cool']
         rawmember[i] = tmp
         attst[i] = member[i][mainatt]
      }
      totalall = 0
      //数值和单体百分比宝石
      for (var i = 0; i < 9; i++) {
         origin = member[i][mainatt]
         member[i][mainatt] += member[i]["gemnum"]
         attst[i] += member[i]["gemnum"]
         if (member[i]["gemsinglepercent"] > 0.2){
            member[i][mainatt] += Math.ceil(0.1*origin)+Math.ceil(0.16*origin)
            attst[i] += Math.ceil(0.1*origin)+Math.ceil(0.16*origin)
         }
         else {
            member[i][mainatt] += Math.ceil(member[i]["gemsinglepercent"]*origin)
            attst[i] += Math.ceil(member[i]["gemsinglepercent"]*origin)
         }
         
      }
      //i带全体宝石，给j加
      teamgem = new Array()
      for (var i = 0; i < 9; i++) {
         teamgem[i] = [0,0,0,0,0,0,0,0,0]
         for (var j = 0;j < 9;j ++){
            if (member[i]["gemallpercent"] > 0.04){
               member[j][mainatt] += Math.ceil(0.018*rawmember[j][mainatt])+Math.ceil(0.024*rawmember[j][mainatt])
               totalall += Math.ceil(0.018*rawmember[j][mainatt])+Math.ceil(0.024*rawmember[j][mainatt])
               teamgem[i][j] = Math.ceil(0.018*rawmember[j][mainatt])+Math.ceil(0.024*rawmember[j][mainatt])
               attst[j] += Math.ceil(0.018*rawmember[j][mainatt])+Math.ceil(0.024*rawmember[j][mainatt])
            }
            else{
               member[j][mainatt] += Math.ceil(member[i]["gemallpercent"]*rawmember[j][mainatt])
               totalall += Math.ceil(member[i]["gemallpercent"]*rawmember[j][mainatt])
               teamgem[i][j] = Math.ceil(member[i]["gemallpercent"]*rawmember[j][mainatt])
               attst[j] += Math.ceil(member[i]["gemallpercent"]*rawmember[j][mainatt])
            }
         }
      }

      rawattst = attst.concat()
      rawteamgem= new Array()
      
      result['baseatt'][mainatt] = 0
      for (var i = 0; i < 9; i++) {
         rawteamgem[i] = teamgem[i].concat()
         result['baseatt'][mainatt] += member[i][mainatt];
      }
      //主c技能
      for (var i = 0; i < 9; i++) {
	  if(Precal){
	  for(var g=1;g<=3;g++){
			for(var j in unitgradechr[g]){
				if(unitgradechr[g][j]==cards[member[i]["cardid"]]["jpname"]){
					grade[i]=g;
				}
			}
		}
	  }
         result['bonusatt'][mapcenter['bonus']] += Math.ceil(mapcenter['percentage']*member[i][mapcenter['base']]/100);
         if (mapcenter['base'] == mainatt){
            attst[i] += Math.ceil(rawattst[i]*mapcenter['percentage']/100)
		//////////
		if(Precal&&(mapcenter['bonus']==mainatt))
		Match_c[i]+=(mapcenter['percentage']/100);
		//////////
            for (var j = 0; j < 9; j++)
               teamgem[j][i] += Math.ceil(rawteamgem[j][i]*mapcenter['percentage']/100)
         }
         else
            attst[i] += Math.ceil(member[i][mapcenter['base']]*mapcenter['percentage']/100)
      }
      //副c技能
      for (var i = 0; i < 9; i++) {
         if (llcard.isInUnitGroup(mapcenter['secondlimit'], cards[member[i]["cardid"]]["jpname"])){
		 ////////////////////
		if(Precal&&(mapcenter['bonus']==mainatt)) Match_c[i]+=(mapcenter['secondpercentage']/100);
		//////////////////////
            result['bonusatt'][mapcenter['secondbase']] += Math.ceil(member[i][mapcenter['secondbase']]*mapcenter['secondpercentage']/100)
            attst[i] += Math.ceil(rawattst[i]*mapcenter['secondpercentage']/100)
            for (var j = 0; j < 9; j++)
               teamgem[j][i] += Math.ceil(rawteamgem[j][i]*mapcenter['secondpercentage']/100)
         }

      }
      //好友主c技能
      for (var i = 0; i < 9; i++) {
         result['bonusatt'][mapcenter['bonus2']] += Math.ceil(mapcenter['percentage2']*member[i][mapcenter['base2']]/100);
         if (mapcenter['base2'] == mainatt){
		 //////////
		if(Precal &&(mapcenter['bonus2']==mainatt)){
		
		Match_c[i]+=(mapcenter['percentage2']/100);
		}
		//////////
            attst[i] += Math.ceil(rawattst[i]*mapcenter['percentage2']/100)
            for (var j = 0; j < 9; j++)
               teamgem[j][i] += Math.ceil(rawteamgem[j][i]*mapcenter['percentage2']/100)
         }
         else
            attst[i] += Math.ceil(member[i][mapcenter['base2']]*mapcenter['percentage2']/100)
      }
      //好友副c技能
      for (var i = 0; i < 9; i++) {
         if (llcard.isInUnitGroup(mapcenter['secondlimit2'], cards[member[i]["cardid"]]["jpname"])){
		 ////////////////////
		if(Precal &&(mapcenter['bonus2']==mainatt))
		 Match_c[i]+=(mapcenter['secondpercentage2']/100);
		//////////////////////
            result['bonusatt'][mapcenter['secondbase2']] += Math.ceil(member[i][mapcenter['secondbase2']]*mapcenter['secondpercentage2']/100)
            attst[i] += Math.ceil(rawattst[i]*mapcenter['secondpercentage2']/100)
            for (var j = 0; j < 9; j++)
               teamgem[j][i] += Math.ceil(rawteamgem[j][i]*mapcenter['secondpercentage2']/100)
         }
      }

      document.getElementById('resultsmile').innerHTML = (result.baseatt.smile+result.bonusatt.smile).toString()+" (+"+result.bonusatt.smile.toString()+")"
      document.getElementById('resultpure').innerHTML = (result.baseatt.pure+result.bonusatt.pure).toString()+" (+"+result.bonusatt.pure.toString()+")"
      document.getElementById('resultcool').innerHTML = (result.baseatt.cool+result.bonusatt.cool).toString()+" (+"+result.bonusatt.cool.toString()+")"


      var showatt = result['bonusatt'][mapcenter['map']]+result['baseatt'][mapcenter['map']];
      var combomulti = cbmulti(mapcenter['combo']);
      var accmulti = 0.88+0.12*(mapcenter['perfect']/mapcenter['combo']);
      var trueatt = showatt

      totalattst = 0
      totalweight = 0
      for (var i = 0; i < 9; i++) {
         totalweight += member[i]['weight']
         for (var j = 0; j < 9; j++){
            attst[i] += teamgem[i][j]
            attst[j] -= teamgem[i][j]
         }
      }
      rawattst = attst.concat()
      totalrawst = 0
      for (var i = 0; i < 9; i++) {
         totalrawst += rawattst[i]
         groupbonus = samegroup(llsong.getSelectedSong(),llcard.cards[member[i]["cardid"]].jpname)
         colorbonus = (mapcenter['map'] == member[i]['main'])
         if (!groupbonus && !colorbonus)
            attst[i] -= Math.round(showatt*member[i]['weight']/totalweight*0.21/1.21)
         else if (!groupbonus || !colorbonus)
            attst[i] -= Math.round(showatt*member[i]['weight']/totalweight*0.1/1.1)
         document.getElementById('attstrength'+String(i)).innerHTML = attst[i].toString()
         totalattst += attst[i]
      }
      
      result['accuracy'] = 0;
      var averageaccuracy = [0,0,0,0,0,0,0,0,0]
      for (var i = 0; i < 9; i++) {
         var skill = member[i]['skill'];
         if (skill == 5) {
            skillc = member[i]['score']*member[i]['possibility']/100/member[i]['require']
            skillc = skillc/(skillc+1.0)
            waste = (1-skillc)*skillc*member[i]['require']/2+skillc*member[i]['score']/2
            skillc = (skillc*mapcenter['time']-waste)/mapcenter['time']
            skillc = parseInt(1000*skillc)/10
            averageaccuracy[i] = skillc
         } else if (skill == 6 || skill == 12) {
            skillc = mapcenter['combo']*member[i]['score']*member[i]['possibility']/100/member[i]['require']/mapcenter['time']
            waste = skillc*member[i]['score']/2
            skillc = mapcenter['combo']*member[i]['score']*member[i]['possibility']/100/member[i]['require']/mapcenter['time']*(mapcenter['combo']-member[i]['require']/2)/mapcenter['combo']
            skillc = (skillc*mapcenter['time']-waste)/mapcenter['time']
            skillc = parseInt(1000*skillc)/10
            averageaccuracy[i] = skillc
         }
      }
      totalaccuracy = 0
      for (var i = 0; i < 9; i++) {
         totalaccuracy += (1-totalaccuracy)*(averageaccuracy[i]/100)  
      }
      /*
      for (var i = 0; i < 9; i++) {
         if (member[i]['gemacc'] == "1"){
            member[i][mainatt]*= (1+0.25*totalaccuracy)
            member[i][mainatt] = parseInt(member[i][mainatt])
            showatt += parseInt(member[i][mainatt]*0.25*totalaccuracy)
         }
      }
      */
      result['minscore'] = 0;
      for (var i = 0; i < 9; i++) {
         //result['minscore'] += Math.floor(showatt/80*member[i]['weight']*combomulti*accmulti*(mapcenter['map'] === member[i]['main'] ? 1.1 : 1)*(samegroup(llsong.getSelectedSong(),llcard.cards[member[i]["cardid"]].jpname) ? 1.1 : 1));
      }
      result['minscore'] = 1.21*totalattst/80*totalweight*combomulti*accmulti*(1+mapcenter['tapup']/100)
      
      result['maxscore'] = result['minscore'];
      result['averagescore'] = result['minscore'];
      result['averageheal'] = 0;
      result['maxheal'] = 0;
      
      var skillchance = [0, 0, 0, 0, 0, 0, 0, 0, 0];
      var averageskillscore = [0, 0, 0, 0, 0, 0, 0, 0, 0];
      var averageheal = [0,0,0,0,0,0,0,0,0]
      

      for (var i = 0; i < 9; i++) {
         var skill = member[i]['skill'];
         member[i]['possibility'] *= (1+mapcenter['skillup']/100)
         if (skill == 1 || skill == 11) {
            skillchance[i] = Math.floor(mapcenter['combo']/member[i]['require']);
            result['maxscore'] += skillchance[i]*member[i]['score'];
            averageskillscore[i] = skillchance[i]*member[i]['possibility']*member[i]['score']/100;
            result['averagescore'] += skillchance[i]*member[i]['possibility']*member[i]['score']/100;
         } else if (skill == 2) {
            skillchance[i] = Math.floor(mapcenter['perfect']/member[i]['require']);
            result['maxscore'] += skillchance[i]*member[i]['score'];
            averageskillscore[i] = skillchance[i]*member[i]['possibility']*member[i]['score']/100;
            result['averagescore'] += skillchance[i]*member[i]['possibility']*member[i]['score']/100;
         } else if (skill == 4) {
            skillchance[i] = Math.floor(mapcenter['time']/member[i]['require']);
            result['maxscore'] += skillchance[i]*member[i]['score'];
            averageskillscore[i] = skillchance[i]*member[i]['possibility']*member[i]['score']/100;
            result['averagescore'] += skillchance[i]*member[i]['possibility']*member[i]['score']/100;
         } else if (skill == 7 || skill == 13) {
            skillchance[i] = Math.floor(mapcenter['combo']/member[i]['require']);
            result['maxheal'] += skillchance[i]*member[i]['score'];
            averageheal[i] = skillchance[i]*member[i]['possibility']*member[i]['score']/100
            result['averageheal'] += skillchance[i]*member[i]['possibility']*member[i]['score']/100;
            if (member[i]['gemskill'] == '1'){
               member[i]["skill"] = 1
               member[i]["score"] *= naipan
               result['maxscore'] += skillchance[i]*member[i]['score'];
               averageskillscore[i] = skillchance[i]*member[i]['possibility']*member[i]['score']/100;
               result['averagescore'] += skillchance[i]*member[i]['possibility']*member[i]['score']/100;
            }
         } else if (skill == 8) {
            skillchance[i] = Math.floor(mapcenter['time']/member[i]['require']);
            result['maxheal'] += skillchance[i]*member[i]['score'];
            averageheal[i] = skillchance[i]*member[i]['possibility']*member[i]['score']/100
            result['averageheal'] += skillchance[i]*member[i]['possibility']*member[i]['score']/100;
            if (member[i]['gemskill'] == '1'){
               member[i]["skill"] = 4
               member[i]["score"] *= naipan
               result['maxscore'] += skillchance[i]*member[i]['score'];
               averageskillscore[i] = skillchance[i]*member[i]['possibility']*member[i]['score']/100;
               result['averagescore'] += skillchance[i]*member[i]['possibility']*member[i]['score']/100;
            }
         } else if (skill == 9) {
            skillchance[i] = Math.floor(mapcenter['perfect']/member[i]['require']);
            result['maxheal'] += skillchance[i]*member[i]['score'];
            averageheal[i] = skillchance[i]*member[i]['possibility']*member[i]['score']/100
            result['averageheal'] += skillchance[i]*member[i]['possibility']*member[i]['score']/100;
            if (member[i]['gemskill'] == '1'){
               member[i]["skill"] = 2
               member[i]["score"] *= naipan
               result['maxscore'] += skillchance[i]*member[i]['score'];
               averageskillscore[i] = skillchance[i]*member[i]['possibility']*member[i]['score']/100;
               result['averagescore'] += skillchance[i]*member[i]['possibility']*member[i]['score']/100;
            }
         } else if (skill == 10) {
            skillchance[i] = Math.floor(mapcenter['starperfect']/member[i]['require']);
            result['maxscore'] += skillchance[i]*member[i]['score'];
            averageskillscore[i] = skillchance[i]*member[i]['possibility']*member[i]['score']/100;
            result['averagescore'] += skillchance[i]*member[i]['possibility']*member[i]['score']/100;
         }
      }
      
      var finish = false;
      var infinite = false;
      var averagescoringtimes = [0, 0, 0, 0, 0, 0, 0, 0, 0];
      var maxscoringtimes = [0, 0, 0, 0, 0, 0, 0, 0, 0];
      while (!finish) {
         finish = true;
         if (result['averagescore'] > 10000000) {
            result['averagescore'] = '1000w+';
            infinite = true;
            break;
         }
         for (var i = 0; i < 9; i++) {
            if (member[i]['skill'] == 3 && averagescoringtimes[i] < Math.floor(result['averagescore']/member[i]['require'])) {
               remaintimes = Math.floor(result['averagescore']/member[i]['require'])-averagescoringtimes[i];
               averagescoringtimes[i] += remaintimes;
               averageskillscore[i] += remaintimes*member[i]['possibility']*member[i]['score']/100;
               result['averagescore'] += remaintimes*member[i]['possibility']*member[i]['score']/100;
               finish = false;
            }
         }
      }
      if (!infinite) {
         result['averagescore'] = Math.round(result['averagescore']);
      }
      finish = false;
      infinite = false;
      while (!finish) {
         finish = true;
         if (result['maxscore'] > 10000000) {
            result['maxscore'] = '1000w+';
            infinite = true;
            break
         }
         for (var i = 0; i < 9; i++) {
            if (member[i]['skill'] == 3 && maxscoringtimes[i] < Math.floor(result['maxscore']/member[i]['require'])) {
               remaintimes = Math.floor(result['maxscore']/member[i]['require'])-maxscoringtimes[i];
               maxscoringtimes[i] += remaintimes;
               result['maxscore'] += remaintimes*member[i]['score'];
               finish = false;
            }
         }
      }
      
      if (document.getElementById('distribution').checked && (!Precal)){
         var t0 = window.performance.now();
         
         var percentiles = [0.01, 0.02, 0.05, 0.1, 0.2, 0.3, 0.4, 0.5, 0.6, 0.7, 0.8, 0.9, 0.95, 0.98, 0.99];
         var dist = [[result['minscore'], 1]];
         for (var i = 0; i < 9; i++) {
            var skill = member[i]['skill'];
            if (skill == 1 || skill == 2 || skill == 4 || skill == 10 || skill == 11) {
               for (var j = 0; j < skillchance[i]; j++) {
                  dist = addskill(dist, member[i]['score'], member[i]['possibility'] / 100, 0);
               }
            }
         }
         
         var nextscore = [Infinity, Infinity, Infinity, Infinity, Infinity, Infinity, Infinity, Infinity, Infinity];
         for (var i = 0; i < 9; i++) {
            if (member[i]['skill'] == 3) {
               nextscore[i] = member[i]['require'];
            }
         }
         for (;;) {
            var next = 0;
            for (var i = 1; i < 9; i++) {
               if (nextscore[i] < nextscore[next]) {
                  next = i;
               }
            }
            if ((nextscore[next] > dist[dist.length - 1][0]) || (nextscore[next] > 3000000)) {
               break;
            }
            dist = addskill(dist, member[next]['score'], member[next]['possibility'] / 100, nextscore[next]);
            nextscore[next] += member[next]['require'];
         }
         
         var scores = [];
         var k = 0;
         var p = 0;
         for (var i = 0; i < dist.length && k < percentiles.length; i++) {
            p += dist[i][1];
            for (; k < percentiles.length && p >= percentiles[k]; k++) {
               scores[k] = dist[i][0];
            }
         }
         
         var t1 = window.performance.now();
         console.debug('Elapesd time (ms): ' + (t1 - t0).toFixed(3));
         console.debug('Possibilities: ' + dist.length.toString());
         var p = 0;
         for (var i = 0; i < dist.length; i++) {
            p += dist[i][1];
         }
         console.debug('Total probability (naïve summation): 1 ' + (p >= 1 ? '+ ' : '- ') + Math.abs(p - 1).toString());
         var s0 = 0, s1 = 0;
         for (var i = 0; i < dist.length; i++) {
            var s = s0 + dist[i][1];
            var bb = s - s0;
            var e = (dist[i][1] - bb) + (s0 - (s - bb)) + s1;
            s0 = s + e;
            s1 = e - (s0 - s);
         }
         var ep = (s0 - 1) + s1;
         console.debug('Total probability: 1 ' + (ep >= 0 ? '+ ' : '- ') + Math.abs(ep).toString());
         var meanscore = 0;
         for (var i = 0; i < dist.length; i++) {
            meanscore += dist[i][0] * dist[i][1];
         }
         document.getElementById('averagescore').innerHTML = meanscore.toFixed(0).toString()
         console.debug('Mean score: ' + meanscore.toString());
         
         console.debug(result);
         for (i in scores){
            document.getElementById('simresult'+(100-percentiles[i]*100).toString()).innerHTML = scores[i].toFixed(0).toString()
         }
      }
      else{
		gettotalstrength=result['averagescore']
         document.getElementById('averagescore').innerHTML = result['averagescore'].toString()
		 }

      document.getElementById('resultstrength').innerHTML = (result.averagescore/result.minscore*totalattst).toFixed(0).toString()
      document.getElementById('averageheal').innerHTML = result.averageheal
      console.debug(scores);
      
      ttweight = 0
      ttstrength = 0
      for (i=0;i<9;i++)
         ttweight += member[i]['weight']
      skillst = [0,0,0,0,0,0,0,0,0]
      for (i=0;i<9;i++){
         leader = 0

         skillst[i] = parseInt(Math.round(averageskillscore[i]/result.minscore*totalattst/(1+mapcenter['skillup']/100)*(1+mapcenter['tapup']/100)).toFixed(0))
      }
      for (i=0;i<9;i++){
         document.getElementById('cardstrength'+String(i)).innerHTML = (rawattst[i]+skillst[i]).toString()
         document.getElementById('strength'+String(i)).innerHTML = (attst[i]+skillst[i]).toString()
         document.getElementById('skillstrength'+String(i)).innerHTML = skillst[i].toString()
		 /////
		if(Precal) skillP[i]=skillst[i];
		 /////
         document.getElementById('heal'+String(i)).innerHTML = averageheal[i].toString()
         ttstrength += (attst[i]+skillst[i])
      }
	  
      document.getElementById('resultstrength').innerHTML = ttstrength.toFixed(0).toString()+' (属性 '+totalattst.toString()+' + 技能 '+(ttstrength-totalattst).toString()+')'
      minstrength = 100000000
      minwhich = -1
      mincardstrength = 100000000
      mincard = -1
      for (i=0;i<9;i++){
         document.getElementById('strength'+String(i)).style.color = ''
         document.getElementById('cardstrength'+String(i)).style.color = ''
         if (parseInt(document.getElementById('strength'+String(i)).innerHTML) < minstrength){
            minwhich = i
            minstrength = parseInt(document.getElementById('strength'+String(i)).innerHTML)
         }
         if (parseInt(document.getElementById('cardstrength'+String(i)).innerHTML) < mincardstrength){
            mincard = i
            mincardstrength = parseInt(document.getElementById('cardstrength'+String(i)).innerHTML)
         }
         trueacc = 100*(averageaccuracy[i]/100)*(1-totalaccuracy)/(1-averageaccuracy[i]/100)
	      calslot(i);
         //document.getElementById('accuracy'+String(i)).innerHTML = trueacc.toFixed(1).toString()+'%<br>('+averageaccuracy[i].toString()+'%)'
      }
      //document.getElementById('averageaccuracy').innerHTML = (totalaccuracy*100).toFixed(1).toString()+'%'
      document.getElementById('result').style.display = ""
      document.getElementById('strength'+String(minwhich)).style.color = 'red'
      document.getElementById('cardstrength'+String(mincard)).style.color = 'red'
   }

   function callback(){
   	alert('4')
   }
   </script>
{% endblock %}

{% block body_onload %}
   <body onload="defer_onload.resolve()" lang="zh-Hans">
{% endblock %}

{% block front_notice %}
<h4 class="alert-heading">使用方法</h4>
<ol>
      <li>选择歌曲 或 填写歌曲详细信息 <font style='color:red'><b>务必记得修改perfect数量</b></font></li>
      <li>从卡牌库中选择一张卡，点击转移来放置到对应位置，没有录入的卡片数据可以手动输入 <font style='color:red'><b>一张卡默认为满级、一级技能的数据，若不是则需要修改</b></font></li>
      <li>使用以上方法选择所有的9张卡</li>
      <li>可以点击「保存队伍」将队伍配置文件保存到本地</li>
      <li>第2、3步可以从保存的文件中读取队伍信息来代替：点击「选择文件」选择本地配置文件，再点击「读取队伍」</li>
	<li>选择主唱技能和好友主唱技能 <font style='color:red'><b>计算SM得分时将好友主唱加成设为0%</b></font></li>
	<li>勾选或取消「自动配饰」选择是否在点击Calculate计算时自动计算最优策略 勾选后请填写每种偶像技能的拥有数量，「保存仓库」与「读取仓库」可以存取宝石文件信息</li>
	<li>选择卡片后点击「添加后备」可设为增加候补成员，其下方的选择文件与读取队伍可以将后备队伍文件或队伍文件作为后备成员添加到后备中</li>
	<li>选择后备成员界面中的「保存全卡」可以保存所有成员，包括队伍与后备，点击「队伍填充」可将后备成员前8名填充至除主唱外的位置中</li>
      <li>点击Calculate</li>
	<li>更多详情，请访问<a href="https://tieba.baidu.com/p/5242588398"><font color="#FF0000"><b>说明与反馈</b></font></a></li>
</ol>

<p>当前版本：4.1及以上。</p>
{% endblock %}

{% block main %}
<input type="submit" name="clear" value="清空输入" onclick="clearall()"><br>
<form action="" id="unitform" name="unitform" method="POST" onsubmit="return check()" enctype=multipart/form-data>
<!--<form action="/llloadunit"  onsubmit=""  target="if">-->
<h3>歌曲信息</h3>
搜索：<input type="text" id="songsearch" name="songsearch" value=""></input><br>
筛选：
	<select id="songatt" name="songatt">
		<option value="">属性</option>
		<option value="smile">smile</option>
		<option value="pure">pure</option>
		<option value="cool">cool</option>
	</select>
	<select id="songunit" name="songunit">
		<option value="">组合</option>
		<option value="muse">μ's</option>
		<option value="aqours">Aqours</option>
	</select><br>
歌曲：<select id="songchoice" name="songchoice">
		<option value=""> </option>
	</select>
	<input type="button" id="language" name="language" onclick="changeLanguage()" value="切换语言"></input>
	<br>
   难度：<select id="diffchoice" name="diffchoice">
      <option value="easy">easy</option>
      <option value="normal">normal</option>
      <option value="hard">hard</option>
      <option value="expert" SELECTED>expert</option>
      <option value="master">master</option>
   </select><br>
	图属性 :<select id="map" name="map" onchange="changemapcolor();">
		<option value="smile">smile</option>
		<option value="pure">pure</option>
		<option value="cool">cool</option>
	</select><br>
	总combo数 :<input type="text" id="combo" name="combo" value="300" autocomplete="off" style="width:50px"><br>
	perfect数:<input type="text" id="perfect" name="perfect" value="285" autocomplete="off" style="width:50px"><br>
	时间:<input type="text" id="time" name="time" value="100" autocomplete="off" style="width:50px">秒（从人物出现到最后一个note被击打的时间，不是歌曲长度。部分谱面无长度数据，默认值为110秒）<br>
	星星perfect数:<input type="text" id="starperfect" name="starperfect" value="47" autocomplete="off" style="width:50px">（只有星星系加分需要填写）<br>
<br>

{% include 'components/card-selector.html' %}

<div style="float:left">
<input type="button" id="addSubselect" value="添加后备" onclick="addselectsub()" ></input>
<input type="file" name="filesub">
<input type="submit" value="读取队伍" onclick="loadsubmembers()">
</div>
<br><br>
<div style="clear:both"></div>

<div id="submembersoperation" style="display: none">
<h4> 备选成员<input type="button" value="保存后备" onclick="savesubmembers()"><input type="button" value="保存全卡" onclick="saveallmembers()"><input type="button" value="队伍填充" onclick="fillunit()"></h4>
</div>
<div id="submembers">
</div>
<h3>队伍属性</h3>
<div>
<div style="float:left">
<table border='1'>
   <tr>
      <td>权重</td>
      {% for i in range(0,9) %}
      <td><input type="text" id="weight{{i}}" name="weight{{i}}" size=2 autocomplete="off"></td>
      {% endfor %}
   </tr>
   <tr>
      <td></td>
      {% for i in range(0,9) %}
      <td><input type="button" value="放卡{{i+1}}" onclick="LLUnit.copyTo({{i}})"></td>
      {% endfor %}
   </tr>
   <tr>
      <td>卡片</td>
   	<td ><img  id='avatar0' src='/static/null.png'/></td>
   	<td><img  id='avatar1' src='/static/null.png'/></td>
   	<td><img  id='avatar2' src='/static/null.png'/></td>
   	<td><img  id='avatar3' src='/static/null.png'/></td>
   	<td><img  id='avatar4' src='/static/null.png'/></td>
   	<td><img  id='avatar5' src='/static/null.png'/></td>
   	<td><img  id='avatar6' src='/static/null.png'/></td>
   	<td><img  id='avatar7' src='/static/null.png'/></td>
   	<td><img  id='avatar8' src='/static/null.png'/></td>
   </tr>
   <tr style="display:none">
      <td>id</td>
      {% for i in range(0,9) %}
      <td><input type="text" id="cardid{{i}}" name="cardid{{i}}" size=1 value=0 autocomplete="off"></td>
      {% endfor %}
   </tr>
   <tr style="display:none">
      <td>mezame</td>
      {% for i in range(0,9) %}
      <td><input type="text" id="mezame{{i}}" name="mezame{{i}}" size=1 value=0 autocomplete="off"></td>
      {% endfor %}
   </tr>
   <tr>
      <td>主属性</td>
      {% for i in range(0,9) %}
      <td><select id="main{{i}}" name="main{{i}}">
         <option value="smile" style="color:red">smile</option>
         <option value="pure" style="color:green">pure</option>
         <option value="cool" style="color:blue">cool</option>
      </select></td>
      {% endfor %}
   </tr>
   <tr>
      <td style="color:red">smile</td>
      {% for i in range(0,9) %}
      <td><input type="text" style="color:red" id="smile{{i}}" name="smile{{i}}" size=3 autocomplete="off"></td>
      {% endfor %}
   </tr>
   <tr>
      <td style="color:green">pure</td>
      {% for i in range(0,9) %}
      <td><input type="text" style="color:green" id="pure{{i}}" name="pure{{i}}" size=3 autocomplete="off"></td>
      {% endfor %}
   </tr>
   <tr>
      <td style="color:blue">cool</td>
      {% for i in range(0,9) %}
      <td><input type="text" style="color:blue" id="cool{{i}}" name="cool{{i}}" size=3 autocomplete="off"></td>
      {% endfor %}
	</tr>
	<tr>
      <td>总槽数</td>
      {% for i in range(0,9) %}
      <td><input type="text" id="maxcost{{i}}" name="maxcost{{i}}" value="1" autocomplete="off" size=1 style="width:40px"></td>
      {% endfor %}
   </tr>
   <tr>
      <td>技能</td>
      {% for i in range(0,9) %}
      <td>Lv<input type="text" id="skilllevel{{i}}" name="skilllevel{{i}}" value="1" autocomplete="off" size=1 style="width:40px" onchange="LLUnit.changeunitskilllevel({{i}})"></td>
      {% endfor %}
   </tr>
   <tr>
      <td>单体数值</td>
      {% for i in range(0,9) %}
      <td><select id="gemnum{{i}}" name="gemnum{{i}}" onchange="calslot({{i}})">
         <option value="0" >0</option>
         <option value="200" >200</option>
         <option value="450" >450</option>
         <option value="650" >650</option>
      </select></td>
      {% endfor %}
   </tr>
   <tr>
      <td>单体百分比</td>
      {% for i in range(0,9) %}
      <td><select id="gemsinglepercent{{i}}" name="gemsinglepercent{{i}}" onchange="calslot({{i}})">
         <option value="0" >0</option>
         <option value="0.1" >10%</option>
         <option value="0.16" >16%</option>
         <option value="0.26" >26%</option>
      </select></td>
      {% endfor %}
   </tr>
   <tr>
      <td>全体百分比</td>
      {% for i in range(0,9) %}
      <td><select id="gemallpercent{{i}}" name="gemallpercent{{i}}" onchange="calslot({{i}})">
         <option value="0" >0</option>
         <option value="0.018" >1.8%</option>
         <option value="0.024" >2.4%</option>
         <option value="0.042" >4.2%</option>
      </select></td>
      {% endfor %}
   </tr>
   <tr>
      <td>奶/分宝石</td>
      {% for i in range(0,9) %}
      <td><select id="gemskill{{i}}" name="gemskill{{i}}" onchange="calslot({{i}})">
         <option value="0" >无</option>
         <option value="1" >有</option>
      </select></td>
      {% endfor %}
   </tr>
   <tr style="display:none">
      <td>判定宝石</td>
      {% for i in range(0,9) %}
      <td><select id="gemacc{{i}}" name="gemacc{{i}}" onchange="calslot({{i}})">
         <option value="0" >无</option>
         <option value="1" >有</option>
      </select></td>
      {% endfor %}
   </tr>
   <tr>
      <td>使用槽数</td>
      {% for i in range(0,9) %}
      <td id="slot{{i}}" name="slot{{i}}"></td>
      {% endfor %}
   </tr>
   <tr>
      <td></td>
      {% for i in range(0,9) %}
      <td><input type="button" id="pos{{i}}" name="pos{{i}}" value="换位{{i+1}}" onclick="changepos({{i}})"></td>
      {% endfor %}
   </tr>
   <tr>
      <td>属性强度</td>
      {% for i in range(0,9) %}
      <td id="attstrength{{i}}"></td>
      {% endfor %}
   </tr>
   <tr>
      <td>技能强度</td>
      {% for i in range(0,9) %}
      <td id="skillstrength{{i}}"></td>
      {% endfor %}
   </tr>
   <tr>
      <td>卡强度</td>
      {% for i in range(0,9) %}
      <td id="cardstrength{{i}}"></td>
      {% endfor %}
   </tr>
   <tr>
      <td>实际强度</td>
      {% for i in range(0,9) %}
      <td id="strength{{i}}"></td>
      {% endfor %}
   </tr>
   <!--
   <tr>
      <td>判定</td>
      {% for i in range(0,9) %}
      <td id="accuracy{{i}}"></td>
      {% endfor %}
   </tr>
-->
   <tr>
      <td>回复</td>
      {% for i in range(0,9) %}
      <td id="heal{{i}}"></td>
      {% endfor %}
   </tr>
</table>
</div>
<div style="float:left">

<input type="button" value="保存队伍" onclick="saveunit()">
<input type="file" name="file"/>
<input type="submit" value="读取队伍" onclick="loadunit()">
<br><br><br>
<div id="sisreserves">
</div>
<div id="testtime">
</div>
</div>

</div>
<div style="clear:both">
</div>

主唱技能 :<select id="bonus" name="bonus">
		<option value="smile" style="color:red">smile</option>
		<option value="pure" style="color:green">pure</option>
		<option value="cool" style="color:blue">cool</option>
	</select>增加<select id="base" name="base">
      <option value="smile" style="color:red">smile</option>
      <option value="pure" style="color:green">pure</option>
      <option value="cool" style="color:blue">cool</option>
   </select>的<select id="percentage" name="percentage">
      <option value=0>0</option>
      <option value=3>3</option>
      <option value=6 SELECTED>6</option>
      <option value=7>7</option>
      <option value=9>9</option>
      <option value=12>12</option>
   </select>%+
   <select id="secondlimit" name="secondlimit">
      <option value=""></option>
      <option value="4" SELECTED>μ's</option>
      <option value="5">Aqours</option>
      <option value="1">一年级</option>
      <option value="2">二年级</option>
      <option value="3">三年级</option>
      <option value="6">Printemps</option>
      <option value="7">lilywhite</option>
      <option value="8">BiBi</option>
      <option value="9">CYaRon!</option>
      <option value="10">AZALEA</option>
      <option value="11">Guilty Kiss</option>
   </select>的<nospan id="secondbase" name="secondbase">
   属性
   <!--
      <option value="smile" style="color:red">smile</option>
      <option value="pure" style="color:green">pure</option>
      <option value="cool" style="color:blue">cool</option>-->
   </nospan>增加<select id="secondpercentage" name="secondpercentage">
      <option value=0 SELECTED>0</option>
      <option value=1>1</option>
      <option value=2>2</option>
      <option value=3>3</option>
      <option value=6>6</option>
   </select>%<br>
好友主唱技能 :<select id="bonus2" name="bonus2">
		<option value="smile" style="color:red">smile</option>
      <option value="pure" style="color:green">pure</option>
      <option value="cool" style="color:blue">cool</option>
	</select>增加<select id="base2" name="base2">
      <option value="smile" style="color:red">smile</option>
      <option value="pure" style="color:green">pure</option>
      <option value="cool" style="color:blue">cool</option>
   </select>的<select id="percentage2" name="percentage2">
      <option value=0 SELECTED>0</option>
      <option value=3>3</option>
      <option value=6>6</option>
      <option value=7>7</option>
      <option value=9>9</option>
      <option value=12>12</option>
   </select>%+
   <select id="secondlimit2" name="secondlimit2">
      <option value=""></option>
      <option value="4" SELECTED>μ's</option>
      <option value="5">Aqours</option>
      <option value="1">一年级</option>
      <option value="2">二年级</option>
      <option value="3">三年级</option>
      <option value="6">Printemps</option>
      <option value="7">lilywhite</option>
      <option value="8">BiBi</option>
      <option value="9">CYaRon!</option>
      <option value="10">AZALEA</option>
      <option value="11">Guilty Kiss</option>
   </select>的<nospan id="secondbase2" name="secondbase2">
   歌曲属性
   <!--
      <option value="smile" style="color:red">smile</option>
      <option value="pure" style="color:green">pure</option>
      <option value="cool" style="color:blue">cool</option>-->
   </nospan>增加<select id="secondpercentage2" name="secondpercentage2">
      <option value=0 SELECTED>0</option>
      <option value=1>1</option>
      <option value=2>2</option>
      <option value=3>3</option>
      <option value=6>6</option>
   </select>%<br>
点击得分增加：<input id="tapup" name="tapup" value="0" size=2></input>%<br>
技能发动率增加：<input id="skillup" name="skillup" value="0" size=2></input>%<br>
<input type="button" value="calculate" onclick="check()"> <input type="checkbox" id="distribution" name="distribution">计算分布</input>
<input type="checkbox" id="autoarm0" name="autoarm0" onclick="autoarm()">自动配饰<!--<input type="checkbox" id="naipan" name="naipan" onchange="changenaipan()">弱奶判宝石</input>-->
   <br><br><br>
</form>

<iframe style="display:none" id='if' name='if' src='about:blank' frameborder='0' allowtransparency="yes"></iframe>

{% include 'components/loadingbox.html' %}

<div id="result" style="display:none">
<table border="1">
<tr>
	<td>smile</td>
	<td>pure</td>
	<td>cool</td>
</tr>
<tr>
	<td id="resultsmile"></td>
	<td id="resultpure"></td>
	<td id="resultcool"></td>
</tr>
</table>
卡组强度:<nospan id="resultstrength"></nospan><br>
期望得分:<nospan id="averagescore"></nospan><br>

期望回复:<nospan id="averageheal"></nospan><br>

<!--期望判定覆盖率：<nospan id="averageaccuracy"></nospan><br>-->

<h3>得分分布</h3>
<table border="1">
<tr>
	<td>1%</td>
	<td>2%</td>
	<td>5%</td>
	<td>10%</td>
	<td>20%</td>
	<td>30%</td>
	<td>40%</td>
	<td>50%</td>
	<td>60%</td>
	<td>70%</td>
	<td>80%</td>
	<td>90%</td>
	<td>95%</td>
	<td>98%</td>
	<td>99%</td>
</tr>
<tr>
	<td id='simresult1'></td>
   <td id='simresult2'></td>
   <td id='simresult5'></td>
   <td id='simresult10'></td>
   <td id='simresult20'></td>
   <td id='simresult30'></td>
   <td id='simresult40'></td>
   <td id='simresult50'></td>
   <td id='simresult60'></td>
   <td id='simresult70'></td>
   <td id='simresult80'></td>
   <td id='simresult90'></td>
   <td id='simresult95'></td>
   <td id='simresult98'></td>
   <td id='simresult99'></td>
</tr>
</table>
</div>
{% endblock %}

{% block back_notice %}
<h4 class="alert-heading">注意</h4>
<ul>
   <li>勾选「计算分布」来计算得分分布。得分分布使用真实分布计算，计算速度比较慢。</li>
   <li>计算「自动配饰」的时候建议先不勾选「计算分布」以免时间过长，得到最优宝石配置后取消「自动配饰」再计算得分分布。</li>
   <li>由于使用歌曲信息计算，最终结果可能会有千分之一的误差</li>
   <li>判定覆盖率仅供参考</li>
   <li>判定期间属性1.25倍的宝石计算有误，暂时按无效计算。</li>
   <li>在队伍中有爆分SR时，由于技能强度会随着队伍强度变化而变化，可能出现多次计算「自动配饰」得到的结果不唯一的情况，此时只需重复计算多次取强度最高者即可。</li>
   <li>为保险起见，请在有后备队员时自动组队计算后再点一次calculate，若有变化请点击「问题反馈」留言</li>
</ul>
{% endblock %}
{% block back_notice_2 %}
<h4 class="alert-heading">说明</h4>
<ul>
   <li>在卡片数据行中的判定指的该卡片的边际判定覆盖率影响，即撤掉这张卡后边际覆盖率的损失。在括号中的覆盖率为单卡判定覆盖率</li>
   <li>卡强度指的是不考虑异色和异团带来的负面影响时的强度，该数值方便异团卡、异色横向比较。实际强度则是考虑异色和异团加成的强度</li>
</ul>
{% endblock %}
