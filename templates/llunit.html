<!DOCTYPE html>
<html>
   <head>
      <title>LLhelper</title>
      <link href="https://libs.baidu.com/bootstrap/3.0.3/css/bootstrap.min.css" rel="stylesheet">
   <script src="https://libs.baidu.com/jquery/2.0.0/jquery.min.js"></script>
   <script src="https://libs.baidu.com/bootstrap/3.0.3/js/bootstrap.min.js"></script>
   <script type="text/javascript" src="{{ url_for('static', filename='twintailosu.js') }}?v=1.01"></script>
   <link rel="shortcut icon" href="/static/shortcuticon.png" />
   <style type="text/css">
   	img {height:65px;width:65px}
   </style>
   <script>
   var regS = new RegExp("&#34;", "g")
   var regS2 = new RegExp("&#39;", "g")
   var regSand = new RegExp("&amp;", "g")
   var cardsjson = "{{cardsjson}}".replace(regS,'"').replace(regS2, "'").replace(regSand, '&')
   var songsjson = "{{songsjson}}".replace(regS,'"').replace(regS2, "'").replace(regSand, '&')
   var cards = eval("("+cardsjson+")")
   var songs = eval("("+songsjson+")")
   var attcolor = new Array();
   var mezame = 0
   var language = 0
   attcolor["smile"] = "red"
   attcolor["pure"] = "green"
   attcolor["cool"] = "blue"
   var kizuna = new Array();
   kizuna["N"] = [25, 50]
   kizuna["R"] = [100, 200]
   kizuna["SR"] = [250, 500]
   kizuna["UR"] = [500, 1000]
   nametojp = new Array()
   nametojp["高坂穗乃果"] = "高坂穂乃果"
   nametojp["绚濑绘里"] = "絢瀬絵里"
   nametojp["南小鸟"] = "南ことり"
   nametojp["园田海未"] = "園田海未"
   nametojp["星空凛"] = "星空凛"
   nametojp["西木野真姬"] = "西木野真姫"
   nametojp["东条希"] = "東條希"
   nametojp["小泉花阳"] = "小泉花陽"
   nametojp["矢泽妮可"] = "矢澤にこ"
   
   var skilllevel = 0

   function threetonumber(three){
      result = three
      if (result[0] == '0'){
         result = result[1]+result[2]
      }
      if (result[0] == '0'){
         result = result[1]
      }
      return result
   }

   function lvlup(){
      skilllevel += 1
      if (skilllevel == 8)
         skilllevel = 0
      changeskilllevel()
   }

   function lvldown(){
      skilllevel -= 1
      if (skilllevel == -1)
         skilllevel = 7
      changeskilllevel()
   }

   function changeskilllevel(){
      document.getElementById('skilllevel').innerHTML = String(skilllevel+1)
      index = document.getElementById('cardchoice').value
      if (cards[index].skill){
         document.getElementById('require').value = cards[index]['skilldetail'][skilllevel].require
         document.getElementById('possibility').value = cards[index]['skilldetail'][skilllevel].possibility
         document.getElementById('score').value = cards[index]['skilldetail'][skilllevel].score
      }
   }

   function changeunitskilllevel(n){
      index = document.getElementById('cardid'+String(n)).value
      level = parseInt(document.getElementById('skilllevel'+String(n)).value)-1
      if ((level < 0) || (level > 7)) return
      document.getElementById('require'+String(n)).value = cards[index]['skilldetail'][level].require
      document.getElementById('possibility'+String(n)).value = cards[index]['skilldetail'][level].possibility
      document.getElementById('score'+String(n)).value = cards[index]['skilldetail'][level].score
   }

   function getskilllevel(n){

      score = document.getElementById('score'+String(n)).value
      index = threetonumber(document.getElementById('cardid'+String(n)).value)
      if (!cards[index].skill) return 0
      for (i=0;i<8;i++){
         if (cards[index]['skilldetail'][i].score == score)
            return i+1
      }
      return 0
   }

   function cardtoskilltype(c){
      if (!c.skill)
         return 0
      if ((c.skilleffect == 4) || (c.skilleffect == 5)){
         if (c.triggertype == 1)
            return 5
         else if (c.triggertype == 3)
            return 6
         else if (c.triggertype == 4)
            return 12
      }
      else if (c.skilleffect == 9){
         if (c.triggertype == 1)
            return 8
         else if (c.triggertype == 3)
            return 7
         else if (c.triggertype == 4)
            return 13
         else if (c.triggertype == 6)
            return 9
      }
      else if (c.skilleffect == 11){
         if (c.triggertype == 1)
            return 4
         else if (c.triggertype == 3)
            return 1
         else if (c.triggertype == 4)
            return 11
         else if (c.triggertype == 5)
            return 3
         else if (c.triggertype == 6)
            return 2
         else if (c.triggertype == 12)
            return 10
      }
   }

   function getcardselect(rarity, chr, att, cnhave, cardtype,special){
      sel = document.getElementById("cardchoice");
      skilltype = document.getElementById("skilltype").value
      triggertype = document.getElementById("triggertype").value
      setname = document.getElementById("setname").value
      sel.options.length = 1;
      var index = 1;
      //alert(chr)
      for (card in cards){
         if (((rarity == "") || (rarity == cards[index].rarity)) && ((chr == "") || (cards[index].jpname.indexOf(nametojp[chr]) != -1)) && ((att == "") || (att == cards[index].attribute)) && ((cnhave == "") || (cnhave == cards[index].cnhave)) && ((special == "") || ((cards[index].special == 0) && (special == 0)) || ((cards[index].special == 1) && (special == 1))) && ((cardtype == "") || (cards[index].type.indexOf(cardtype) != -1)) && ((skilltype == "") || (skilltype == cards[index].skilleffect)) && ((triggertype == "") || (triggertype == cards[index].triggertype)) && ((setname == "") || (setname == cards[index].jpseries))){
            if ((!(document.getElementById('showncard').checked) && (cards[index].rarity == 'N')) || (cards[index].support == 1)){
               index += 1
               continue
            }
            var newOption
            if (cards[index].eponym) {eponym = "【"+cards[index].eponym+"】"} else eponym = ""
            if (cards[index].series && (cards[index].series != '')) {series = "("+cards[index].series+")"} else series = ""
            if (cards[index].jpeponym) {jpeponym = "【"+cards[index].jpeponym+"】"} else jpeponym = ""
            if (cards[index].jpseries && (cards[index].jpseries != '')) {jpseries = "("+cards[index].jpseries+")"} else jpseries = ""
            if (language == 0)
               newOption = new Option(tothree(cards[index].id)+" "+cards[index].rarity+" "+eponym+cards[index].name+" "+series, index)
            else
               newOption = new Option(tothree(cards[index].id)+" "+cards[index].rarity+" "+jpeponym+cards[index].jpname+" "+jpseries, index)
            newOption.style.color = attcolor[cards[index].attribute]
            sel.options.add(newOption)
         }
         index += 1
      }
      //changecolor("cardchoice")
   }
   
   function getsongselect(diff, att, cnhave, type){
      sel = document.getElementById("songchoice");
      diffc = document.getElementById('diff').value
      var keyword = document.getElementById("songsearch").value
      var smnum =document.getElementById("smfilter").value
      var mfnum =document.getElementById("mffilter").value
      sel.options.length = 1;
      for (index in songs){
         if (((att == "") || (att == songs[index].attribute)) && ((cnhave == "") || (cnhave == songs[index]['hard']['cnhave'])) && ((type == "") || (songs[index].type.indexOf(type) != -1))){
         if ((keyword == "") || (songs[index].name.toLowerCase().indexOf(keyword.toLowerCase()) != -1) || (songs[index].jpname.toLowerCase().indexOf(keyword.toLowerCase()) != -1)){
            smhave = false
            if (smnum != ""){
               if (diffc == ''){
                  smList = songs[index]['hard'].sm.split(" ")
                  if (songs[index]['expert'] != null)
                     smList = (songs[index]['hard'].sm+' '+songs[index]['expert'].sm).split(" ")
               }
               else if (diffc == 'expert'){
                  smList = []
                  if (songs[index]['expert'] != null)
                     smList = songs[index]['expert'].sm.split(" ")
               }
               else{
                  smList = songs[index]['hard'].sm.split(" ")
               }
               for (i in smList){
                  if (smnum == smList[i]){
                     smhave = true
                     break
                  }
               }
            }
            mfhave = false
            if (mfnum != ""){
               if (diffc == ''){
                  mfList = songs[index]['hard'].mf.split(" ")
                  if (songs[index]['expert'] != null)
                     mfList = (songs[index]['hard'].mf+' '+songs[index]['expert'].mf).split(" ")
               }
               else if (diffc == 'expert'){
                  mfList = []
                  if (songs[index]['expert'] != null)
                     mfList = songs[index]['expert'].mf.split(" ")
               }
               else{
                  mfList = songs[index]['hard'].mf.split(" ")
               }
               for (i in mfList){
                  if (mfnum == mfList[i]){
                     mfhave = true
                     break
                  }
               }
            }
            //alert(smhave)
            if (((smnum == "") || smhave) && ((mfnum == "") || mfhave)){
               var newOption
               if (language == 0)
                  newOption = new Option(songs[index].name, index)
               else
                  newOption = new Option(songs[index].jpname, index)
               newOption.style.color = attcolor[songs[index].attribute]
               sel.options.add(newOption)
            }
            
         }
         }
         index += 1
      }
      //changesongcolor("songchoice")
   }
   
   function havevalue(selectId, value){
   	objSelect = document.getElementById(selectId)
   	for (var i = 0; i < objSelect.options.length; i++){
   		if (objSelect.options[i].value == value)
   			return true;
   	}
   	return false;
   }
   
   function changesongselect(){
   	diff = document.getElementById("diff").value
   	att = document.getElementById("songatt").value
   	cnhave = document.getElementById("songcnhave").value
   	type = document.getElementById("type").value
   	var songchoice = document.getElementById("songchoice").value
   	getsongselect(diff, att, cnhave, type)
   	if (havevalue("songchoice", songchoice)){
   		document.getElementById("songchoice").value = songchoice
   	}
   	changesongcolor("songchoice")
   }
   
   function changecardselect(){
      rarity = document.getElementById("rarity").value
      chr = document.getElementById("chr").value
      att = document.getElementById("att").value
      cnhave = document.getElementById("cnhave").value
      cardtype = document.getElementById("cardtype").value
      special = document.getElementById("special").value
      var cardchoice = document.getElementById("cardchoice").value
      getcardselect(rarity, chr, att, cnhave, cardtype, special)
      if (havevalue("cardchoice", cardchoice)){
         document.getElementById("cardchoice").value = cardchoice
      }
      changecolor("cardchoice")
   }
   
   function changecolor(which){
   	index = document.getElementById(which).value
   	if (index != "") {
   		c = attcolor[cards[index].attribute]
   		document.getElementById(which).style.color = c
   		document.getElementById("main").value = cards[index].attribute
   		
         document.getElementById('skill').value = cardtoskilltype(cards[index])
         if (cards[index].skill){
            document.getElementById('require').value = cards[index]['skilldetail'][skilllevel].require
            document.getElementById('possibility').value = cards[index]['skilldetail'][skilllevel].possibility
            document.getElementById('score').value = cards[index]['skilldetail'][skilllevel].score
         }
   		infolist2 = ["smile", "pure", "cool"]
   		if (mezame == 0){
   			for (i in infolist2){
   				document.getElementById(infolist2[i]).value = cards[index][infolist2[i]]
   				document.getElementById("mezame").value = "未觉醒"
   			}
   		}
   		else{
   			for (i in infolist2){
   				document.getElementById(infolist2[i]).value = cards[index][infolist2[i]+"2"]
   				document.getElementById("mezame").value = "已觉醒"
   			}
   		}
   		document.getElementById("kizuna").value = kizuna[cards[index].rarity][mezame]
   		changeskilltext("")
   	}
   	changeavatarselect()
   }
   
   function changesongcolor(which){
   	index = document.getElementById(which).value
      diff = document.getElementById('diffchoice').value
   	if (index != "") {
   		c = attcolor[songs[index].attribute]
   		document.getElementById(which).style.color = c
   		selectlist = ["map", "bonus", "bonus2"]
   		for (i in selectlist){
   			document.getElementById(selectlist[i]).value = songs[index].attribute
   		}
   		if (document.getElementById("percentage").value != 12)
   			document.getElementById("base").value = songs[index].attribute
   		if (document.getElementById("percentage2").value != 12)
   			document.getElementById("base2").value = songs[index].attribute
   		infolist = ["combo",  "time", "star"]
   		for (i in infolist){
   			document.getElementById(infolist[i]).value = songs[index][diff][infolist[i]]
   		}
         totalweight = 0
         for (i = 0; i < 9; i++)
            totalweight += parseFloat(songs[index][diff]['positionweight'][i])
         c = parseInt(songs[index][diff].combo)
         sl = (totalweight-c)*100/0.25/c
         document.getElementById('slider').value = sl.toFixed(1)
   		document.getElementById("perfect").value = parseInt(parseInt(document.getElementById("combo").value)*19/20)
   		document.getElementById("starperfect").value = parseInt(parseInt(document.getElementById("star").value)*19/20)
   		for (i = 0; i < 9; i++){
   			document.getElementById("weight"+String(i)).value = parseFloat(songs[index][diff]["positionweight"][i])
   		}
   	}
   }
   
   function cardidtoindex(n){
   	cardid = parseInt(n)
   	for (i in cards){
   		if (cards[i].id == n){
   			return i
   		}
   	}
   }
   
   function copyTo(n){
   	copyList = ["main", "smile", "pure", "cool", "kizuna","skill", "require", "possibility", "score"]
   	for (i in copyList){
   		document.getElementById(copyList[i]+String(n)).value = document.getElementById(copyList[i]).value
   	}
      document.getElementById("skilllevel"+String(n)).value = document.getElementById('skilllevel').innerHTML
   	document.getElementById("mezame"+String(n)).value = mezame
   	document.getElementById("cardid"+String(n)).value = cards[String(document.getElementById("cardchoice").value)].id
   	changeskilltext(n)
   	if (n == 4){
   		changecenter()
   	}
   	changeavatar(n)
   }
   
   function changecenter(){
   	cardid = parseInt(document.getElementById("cardid4").value)
   	index = 0
   	for (i in cards){
   		if (cards[i].id == cardid){
   			index = i
   			break
   		}
   	}
   	document.getElementById("bonus").value = cards[index]["attribute"]
   	document.getElementById("percentage").value = cards[index]["Cskillpercentage"]
   	document.getElementById("base").value = cards[index]["Cskillattribute"]
   }
   
   function tothree(string){
   	str = String(string)
   	while (str.length < 3){
   		str = '0'+str
   	}
   	return str
   }
   
   function carddata(cardid){
      for (index = 0; index < cards.length; index++){
         if (cards[index]['id'] == cardid)
            return cards[index]
      }
      return ''
   }

   function changeavatar(n){
   	cardid = threetonumber(document.getElementById('cardid'+String(n)).value)
   	if ((cardid == 0) || (cardid == "") || (cardid == "0"))
   		document.getElementById('avatar'+String(n)).src = '/static/null.png'
   	else if (document.getElementById('mezame'+String(n)).value == 0)
         document.getElementById('avatar'+String(n)).src = cards[cardid].avatarpath
   	else
   		document.getElementById('avatar'+String(n)).src = cards[cardid].avatarpluspath
   }
   
   function changeavatarselect(){
   	document.getElementById('imageselect').src = '/static/null.png'
   	cardid = 0
   	if (document.getElementById('cardchoice').value != '')
   		cardid = cards[document.getElementById('cardchoice').value].id
   	if ((cardid == 0) || (cardid == "") || (cardid == "0"))
   		document.getElementById('imageselect').src = '/static/null.png'
   	else if (mezame == 0)
   		document.getElementById('imageselect').src = cards[document.getElementById('cardchoice').value].avatarpath
   	else
   		document.getElementById('imageselect').src = cards[document.getElementById('cardchoice').value].avatarpluspath
   }
   
   function changeLanguage(){
   	var cardchoice = document.getElementById("cardchoice").value
   	var songchoice = document.getElementById("songchoice").value
   	language = 1-language
   	changecardselect()
   	changesongselect()
   	document.getElementById("cardchoice").value = cardchoice
   	document.getElementById("songchoice").value = songchoice
   }
   
   function changeskilltext(n){
   	var postfix = ""
   	if ((n != "") || (String(n) == "0")) 
   		postfix = String(n)
   	var skilltype = document.getElementById("skill"+postfix).value
   	if (skilltype == 0)
   		document.getElementById("skilltext"+postfix).style.display = "none"
   	else 
   		document.getElementById("skilltext"+postfix).style.display = ""
   	//require
   	if ((skilltype == 1) || (skilltype == 6) || (skilltype == 7))
   		document.getElementById("requiretext"+postfix).innerHTML = "个图标"
   	else if ((skilltype == 2) || (skilltype == 9))
   		document.getElementById("requiretext"+postfix).innerHTML = "个perfect"
   	else if (skilltype == 3)
   		document.getElementById("requiretext"+postfix).innerHTML = "分"
   	else if (skilltype == 10)
   		document.getElementById("requiretext"+postfix).innerHTML = "星星perfect"
   	else if ((skilltype == 4) || (skilltype == 5) || (skilltype == 8))
   		document.getElementById("requiretext"+postfix).innerHTML = "秒"
   	else if ((skilltype == 11) || (skilltype == 12) || (skilltype == 13))
   		document.getElementById("requiretext"+postfix).innerHTML = "combo"
   	//effect
   	if ((skilltype == 1) || (skilltype == 2) || (skilltype == 3) || (skilltype == 4) || (skilltype == 10) || (skilltype == 11)){
   		document.getElementById("effecttext"+postfix).innerHTML = "增加"
   		document.getElementById("unittext"+postfix).innerHTML = "分"
   	}
   	if ((skilltype == 5) || (skilltype == 6) || (skilltype == 12)){
   		document.getElementById("effecttext"+postfix).innerHTML = "增强判定"
   		document.getElementById("unittext"+postfix).innerHTML = "秒"
   	}
   	if ((skilltype == 7) || (skilltype == 8) || (skilltype == 9) || (skilltype == 13)){
   		document.getElementById("effecttext"+postfix).innerHTML = "回复"
   		document.getElementById("unittext"+postfix).innerHTML = "点体力"
   	}
   }
   
   function toMezame(){
   	mezame = 1-mezame
   	changecolor("cardchoice")
   	changeavatarselect()
   }
   
   function clearall(){
   	var inputs = document.getElementsByTagName("input");
   	var selects = document.getElementsByTagName("select");
   	for (var i=0; i<inputs.length; i++){
   		setCookie(inputs[i].name+"unit", inputs[i].value, -1);
   	}
   	for (var i=0; i<selects.length; i++){
   		setCookie(selects[i].name+"unit", selects[i].value, -1);
   	}
   	setCookie("mezame"+"unit", mezame, -1)
   	window.location.href="/llunit"
   }
   
   function saveunit(){
   	member = [{}, {}, {},{},{},{},{},{},{}]
   	saveatt = ['smile', 'pure', 'cool', 'kizuna', 'skill', 'require', 'possibility','score', 'cardid', 'mezame']
   	for (i=0;i<9;i++){
   		for (j in saveatt){
   			member[i][saveatt[j]] = document.getElementById(saveatt[j]+String(i)).value
   		}
   	}
   	unitjson = JSON.stringify(member)
   	window.location.href="/llsaveunit/"+unitjson
   }
   
   var tmponsubmit
   function loadunit(){
   	document.getElementById("unitform").action = '/llloadunit'
   	tmponsubmit = document.getElementById("unitform").onsubmit
   	document.getElementById("unitform").onsubmit = ''
   	document.getElementById("unitform").target = 'if'
   }
   
   function precalcu(){
   	document.getElementById("unitform").action = ''
   	document.getElementById("unitform").onsubmit = tmponsubmit
   	document.getElementById("unitform").target = ''
   }
   
   function init(){
   	//document.getElementById('avatar0').src = 'http://i2.tietuku.com/8baa9a87cc083022.jpg'
      skilllevel = 0
   	mezame = getCookie("mezameunit")
   	language = getCookie("languageunit")
   	if (mezame == "")
   		mezame = 0
   	if (language == "")
   		language = 0
   	
   	getcardselect("", "", "", "", "", "");
   	getsongselect("", "", "", "");
   	var inputs = document.getElementsByTagName("input");
   	var selects = document.getElementsByTagName("select");
   	for (var i=0; i<inputs.length; i++){
   		if (inputs[i].type == "text")
   			if (getCookie(inputs[i].name+"unit") != "")
   				inputs[i].value = getCookie(inputs[i].name+"unit");
   	}
   	for (var i=0; i<selects.length; i++){
   		if (getCookie(selects[i].name+"unit") != "")
   			selects[i].value = getCookie(selects[i].name+"unit");
   	}
   	if (mezame == 1)
   		document.getElementById("mezame").checked = mezame
   	//selects["cardchoice"].value = getCookie(selects["cardchoice"].name);
   	//selects["songchoice"].value = getCookie(selects["songchoice"].name);
   	changeskilltext("")
   	changeavatarselect()
   	for (i = 0; i < 9; i++){
   		changeskilltext(i)
   		changeavatar(i)
   	}
   	document.getElementById("songsearch").value = ""
   	{% if data.calculate == 1 %}
		sortstrength()
	{% endif %}
   	//changecolor("cardchoice")
   	//changesongcolor("songchoice")
   	document.getElementById("songchoice").style.color = attcolor[songs[document.getElementById("songchoice").value].attribute]
   	document.getElementById("cardchoice").style.color = attcolor[cards[document.getElementById("cardchoice").value].attribute]
   }
   
   function changediffinfo(){
      savediff = document.getElementById('diffchoice').value
      index = document.getElementById('songchoice').value
      diffc = document.getElementById('diff').value
      smnum =document.getElementById("smfilter").value
      mfnum =document.getElementById("mffilter").value

      diffsel = document.getElementById('diffchoice')
      diffsel.options.length = 0;
      diffname = ['easy', 'normal', 'hard', 'expert']
      finddiff = false
      for (i in diffname){
         diff = diffname[i]
         if (songs[index][diff] != null){
            cnhave = document.getElementById('songcnhave').value
            if (((songs[index][diff]['cnhave'] == cnhave) || (cnhave == '')) && ((diffc == '') || (diff == diffc))) {
               smhave = false
               if (smnum != ""){
                  smList = songs[index][diff].sm.split(" ")
                  for (i in smList){
                     if (smnum == smList[i]){
                        smhave = true
                        break
                     }
                  }
               }
               mfhave = false
               if (mfnum != ""){
                  mfList = songs[index][diff].mf.split(" ")
                  for (i in mfList){
                     if (mfnum == mfList[i]){
                        mfhave = true
                        break
                     }
                  }
               }
               if (((smnum == "") || smhave) && ((mfnum == "") || mfhave)){
                  newOption = new Option(diff, diff)
                  diffsel.options.add(newOption)
                  if (savediff == diff){
                     document.getElementById('diffchoice').value = savediff
                     finddiff = true
                  }
               }
            }
         }
      }
      if (!finddiff)
         document.getElementById('diffchoice').value = 'hard'
      return 
   }

   function sortstrength(){
   	min = parseInt(document.getElementById("strength0").innerHTML)
   	minnum = 0
   	for (i = 1; i < 9; i++){
   		tmp = parseInt(document.getElementById("strength"+String(i)).innerHTML)
   		if (tmp < min){
   			min = tmp
   			minnum = i
   		}
   	}
   	document.getElementById("strength"+String(minnum)).style.color = "red"
   }
   
   
   function saveToCookie(){
   	var inputs = document.getElementsByTagName("input");
   	var selects = document.getElementsByTagName("select");
   	for (var i=0; i<inputs.length; i++){
   		if (inputs[i].type == "text")
   			setCookie(inputs[i].name+"unit", inputs[i].value, 1);
   	}
   	for (var i=0; i<selects.length; i++){
   		setCookie(selects[i].name+"unit", selects[i].value, 1);
   	}
   	setCookie("mezame"+"unit", mezame, 1)
   	setCookie("language"+"unit", language, 1)
   }
   
   function check(){
   	var inputs = document.getElementsByTagName("input");
   	for (i in inputs){
   		if ((inputs[i].type != "text") || (inputs[i].name == "songsearch"))
   			continue
   		if (!isNumber(inputs[i].value)){
   			alert("请输入数字");
   			return false;
   		}
   	}
   	saveToCookie();
      calculate()
      document.getElementById("result").scrollIntoView()
   	return true;
   }
   
   function cbmulti(cb) {
      if (cb <= 50) {
         return 1;
      } else if (cb <= 100) {
         return 1.1 - 5 / cb;
      } else if (cb <= 200) {
         return 1.15 - 10 / cb;
      } else if (cb <= 400) {
         return 1.2 - 20 / cb;
      } else if (cb <= 600) {
         return 1.25 - 40 / cb;
      } else if (cb <= 800) {
         return 1.3 - 70 / cb;
      } else {
         return 1.35 - 110 / cb;
      }
   }

   function addskill(dist, score, prob, minscore) {
      var newdist = [];
      var q = 1 - prob;
      var i = 0;
      for (; i < dist.length && dist[i][0] < minscore; i++) {
         newdist.push(dist[i]);
      }
      if (i < dist.length) {
         var j = i;
         for (;;) {
            if (dist[i][0] < dist[j][0] + score) {
               newdist.push([dist[i][0], dist[i][1] * q]);
               if (++i >= dist.length) {
                  break;
               }
            } else if (dist[i][0] > dist[j][0] + score) {
               newdist.push([dist[j][0] + score, dist[j][1] * prob]);
               ++j;
            } else {
               newdist.push([dist[i][0], dist[i][1] * q + dist[j][1] * prob]);
               ++j;
               if (++i >= dist.length) {
                  break;
               }
            }
         }
         for (; j < dist.length; j++) {
            newdist.push([dist[j][0] + score, dist[j][1] * prob]);
         }
      }
      return newdist;
   }

   function strengthdetail(i){
    tail = tail || 0
    basic = 0
    if (c.support == 1)
      return 0
    if (c.Cskillpercentage < 12){
      if (mezame == 0)
        basic = parseInt(c[c.attribute]*1.09)+kizuna[c.rarity][0]
      else
        basic = parseInt(c[c.attribute+'2']*1.09)+kizuna[c.rarity][1]
    }
    else{
      if (mezame == 0)
        basic = parseInt(c[c.attribute])+parseInt(c[c.Cskillattribute]*0.12)+kizuna[c.rarity][0]
      else
        basic = parseInt(c[c.attribute+'2'])+parseInt(c[c.Cskillattribute+'2']*0.12)+kizuna[c.rarity][1]
    }
    if (!c.skill)
      return basic
    skill = 0
    if (c.skilleffect == 11)
      skill = skillstrength(c, level, combo, longrate, perfectrate, time, starperfect)
    return basic+skill
   }

   function calculate() {
      var result = {};
      var int_element = ["smile", "pure", "cool", "kizuna", "skill", "require", "possibility"];
      var float_element = ["weight", "score"];
      var sel_element = ['base', 'base2', 'bonus', 'bonus2', 'map'];
      var sel_int = ['percentage', 'percentage2', 'combo', 'perfect', 'star', 'starperfect', 'time'];
      var sel_float = ['slider'];
      var atts = ['smile', 'pure', 'cool'];
      var member = [{}, {}, {}, {}, {}, {}, {}, {}, {}];
      var mapcenter = {};
      result['baseatt'] = {};
      result['bonusatt'] = {};
      for (var i = 0; i < atts.length; i++) {
         result['baseatt'][atts[i]] = 0;
         result['bonusatt'][atts[i]] = 0;
      }
      for (var i = 0; i < sel_int.length; i++) {
         mapcenter[sel_int[i]] = parseInt(document.getElementById(sel_int[i]).value);
      }
      for (var i = 0; i < sel_float.length; i++) {
         mapcenter[sel_float[i]] = parseFloat(document.getElementById(sel_float[i]).value);
      }
      for (var i = 0; i < sel_element.length; i++) {
         mapcenter[sel_element[i]] = document.getElementById(sel_element[i]).value;
      }
      for (var i = 0; i < 9; i++) {
         for (var j = 0; j < int_element.length; j++) {
            member[i][int_element[j]] = parseInt(document.getElementById(int_element[j] + i.toString()).value);
         }
         for (var j = 0; j < float_element.length; j++) {
            member[i][float_element[j]] = parseFloat(document.getElementById(float_element[j] + i.toString()).value);
         }
         member[i]["main"] = document.getElementById("main" + i.toString()).value;
         for (var j = 0; j < atts.length; j++) {
            result['baseatt'][atts[j]] += member[i][atts[j]];
            if (atts[j] === member[i]['main']) {
               result['bonusatt'][atts[j]] += member[i]['kizuna'];
            }
         }
      }
      
      result['bonusatt'][mapcenter['bonus']] += Math.round(mapcenter['percentage']*result['baseatt'][mapcenter['base']]/100);
      result['bonusatt'][mapcenter['bonus2']] += Math.round(mapcenter['percentage2']*result['baseatt'][mapcenter['base2']]/100);
      var showatt = result['bonusatt'][mapcenter['map']]+result['baseatt'][mapcenter['map']];
      var combomulti = cbmulti(mapcenter['combo']);
      var accmulti = 0.88+0.12*(mapcenter['perfect']/mapcenter['combo']);
      
      result['minscore'] = 0;
      for (var i = 0; i < 9; i++) {
         result['minscore'] += Math.floor(showatt/80*member[i]['weight']*combomulti*accmulti*(mapcenter['map'] === member[i]['main'] ? 1.1 : 1));
      }
      
      result['maxscore'] = result['minscore'];
      result['averagescore'] = result['minscore'];
      result['averageheal'] = 0;
      result['maxheal'] = 0;
      result['accuracy'] = 0;
      var skillchance = [0, 0, 0, 0, 0, 0, 0, 0, 0];
      var averageskillscore = [0, 0, 0, 0, 0, 0, 0, 0, 0];
      var averageheal = [0,0,0,0,0,0,0,0,0]
      var averageaccuracy = [0,0,0,0,0,0,0,0,0]

      for (var i = 0; i < 9; i++) {
         var skill = member[i]['skill'];
         if (skill == 1 || skill == 11) {
            skillchance[i] = Math.floor(mapcenter['combo']/member[i]['require']);
            result['maxscore'] += skillchance[i]*member[i]['score'];
            averageskillscore[i] = skillchance[i]*member[i]['possibility']*member[i]['score']/100;
            result['averagescore'] += skillchance[i]*member[i]['possibility']*member[i]['score']/100;
         } else if (skill == 2) {
            skillchance[i] = Math.floor(mapcenter['perfect']/member[i]['require']);
            result['maxscore'] += skillchance[i]*member[i]['score'];
            averageskillscore[i] = skillchance[i]*member[i]['possibility']*member[i]['score']/100;
            result['averagescore'] += skillchance[i]*member[i]['possibility']*member[i]['score']/100;
         } else if (skill == 4) {
            skillchance[i] = Math.floor(mapcenter['time']/member[i]['require']);
            result['maxscore'] += skillchance[i]*member[i]['score'];
            averageskillscore[i] = skillchance[i]*member[i]['possibility']*member[i]['score']/100;
            result['averagescore'] += skillchance[i]*member[i]['possibility']*member[i]['score']/100;
         } else if (skill == 7 || skill == 13) {
            skillchance[i] = Math.floor(mapcenter['combo']/member[i]['require']);
            result['maxheal'] += skillchance[i]*member[i]['score'];
            averageheal[i] = skillchance[i]*member[i]['possibility']*member[i]['score']/100
            result['averageheal'] += skillchance[i]*member[i]['possibility']*member[i]['score']/100;
         } else if (skill == 8) {
            skillchance[i] = Math.floor(mapcenter['time']/member[i]['require']);
            result['maxheal'] += skillchance[i]*member[i]['score'];
            averageheal[i] = skillchance[i]*member[i]['possibility']*member[i]['score']/100
            result['averageheal'] += skillchance[i]*member[i]['possibility']*member[i]['score']/100;
         } else if (skill == 9) {
            skillchance[i] = Math.floor(mapcenter['perfect']/member[i]['require']);
            result['maxheal'] += skillchance[i]*member[i]['score'];
            averageheal[i] = skillchance[i]*member[i]['possibility']*member[i]['score']/100
            result['averageheal'] += skillchance[i]*member[i]['possibility']*member[i]['score']/100;
         } else if (skill == 10) {
            skillchance[i] = Math.floor(mapcenter['starperfect']/member[i]['require']);
            result['maxscore'] += skillchance[i]*member[i]['score'];
            averageskillscore[i] = skillchance[i]*member[i]['possibility']*member[i]['score']/100;
            result['averagescore'] += skillchance[i]*member[i]['possibility']*member[i]['score']/100;
         } else if (skill == 5) {
            skillc = member[i]['score']*member[i]['possibility']/100/member[i]['require']
            skillc = skillc/(skillc+1.0)
            waste = (1-skillc)*skillc*member[i]['require']/2+skillc*member[i]['score']/2
            skillc = (skillc*mapcenter['time']-waste)/mapcenter['time']
            skillc = parseInt(1000*skillc)/10
            averageaccuracy[i] = skillc
         } else if (skill == 6 || skill == 12) {
            skillc = mapcenter['combo']*member[i]['score']*member[i]['possibility']/100/member[i]['require']/mapcenter['time']
            waste = skillc*member[i]['score']/2
            skillc = mapcenter['combo']*member[i]['score']*member[i]['possibility']/100/member[i]['require']/mapcenter['time']*(mapcenter['combo']-member[i]['require']/2)/mapcenter['combo']
            skillc = (skillc*mapcenter['time']-waste)/mapcenter['time']
            skillc = parseInt(1000*skillc)/10
            averageaccuracy[i] = skillc
         }
      }
      
      var finish = false;
      var infinite = false;
      var averagescoringtimes = [0, 0, 0, 0, 0, 0, 0, 0, 0];
      var maxscoringtimes = [0, 0, 0, 0, 0, 0, 0, 0, 0];
      while (!finish) {
         finish = true;
         if (result['averagescore'] > 10000000) {
            result['averagescore'] = '1000w+';
            infinite = true;
            break;
         }
         for (var i = 0; i < 9; i++) {
            if (member[i]['skill'] == 3 && averagescoringtimes[i] < Math.floor(result['averagescore']/member[i]['require'])) {
               remaintimes = Math.floor(result['averagescore']/member[i]['require'])-averagescoringtimes[i];
               averagescoringtimes[i] += remaintimes;
               averageskillscore[i] += remaintimes*member[i]['possibility']*member[i]['score']/100;
               result['averagescore'] += remaintimes*member[i]['possibility']*member[i]['score']/100;
               finish = false;
            }
         }
      }
      if (!infinite) {
         result['averagescore'] = Math.round(result['averagescore']);
      }
      finish = false;
      infinite = false;
      while (!finish) {
         finish = true;
         if (result['maxscore'] > 10000000) {
            result['maxscore'] = '1000w+';
            infinite = true;
            break
         }
         for (var i = 0; i < 9; i++) {
            if (member[i]['skill'] == 3 && maxscoringtimes[i] < Math.floor(result['maxscore']/member[i]['require'])) {
               remaintimes = Math.floor(result['maxscore']/member[i]['require'])-maxscoringtimes[i];
               maxscoringtimes[i] += remaintimes;
               result['maxscore'] += remaintimes*member[i]['score'];
               finish = false;
            }
         }
      }
      
      var t0 = window.performance.now();
      
      var percentiles = [0.01, 0.02, 0.05, 0.1, 0.2, 0.3, 0.4, 0.5, 0.6, 0.7, 0.8, 0.9, 0.95, 0.98, 0.99];
      var dist = [[result['minscore'], 1]];
      for (var i = 0; i < 9; i++) {
         var skill = member[i]['skill'];
         if (skill == 1 || skill == 2 || skill == 4 || skill == 10 || skill == 11) {
            for (var j = 0; j < skillchance[i]; j++) {
               dist = addskill(dist, member[i]['score'], member[i]['possibility'] / 100, 0);
            }
         }
      }
      
      var nextscore = [Infinity, Infinity, Infinity, Infinity, Infinity, Infinity, Infinity, Infinity, Infinity];
      for (var i = 0; i < 9; i++) {
         if (member[i]['skill'] == 3) {
            nextscore[i] = member[i]['require'];
         }
      }
      for (;;) {
         var next = 0;
         for (var i = 1; i < 9; i++) {
            if (nextscore[i] < nextscore[next]) {
               next = i;
            }
         }
         if (nextscore[next] > dist[dist.length - 1][0]) {
            break;
         }
         dist = addskill(dist, member[next]['score'], member[next]['possibility'] / 100, nextscore[next]);
         nextscore[next] += member[next]['require'];
      }
      
      var scores = [];
      var k = 0;
      var p = 0;
      for (var i = 0; i < dist.length && k < percentiles.length; i++) {
         p += dist[i][1];
         for (; k < percentiles.length && p >= percentiles[k]; k++) {
            scores[k] = dist[i][0];
         }
      }
      
      var t1 = window.performance.now();
      console.debug('Elapesd time (ms): ' + (t1 - t0).toFixed(3));
      console.debug('Possibilities: ' + dist.length.toString());
      var p = 0;
      for (var i = 0; i < dist.length; i++) {
         p += dist[i][1];
      }
      console.debug('Total probability (naïve summation): 1 ' + (p >= 1 ? '+ ' : '- ') + Math.abs(p - 1).toString());
      var s0 = 0, s1 = 0;
      for (var i = 0; i < dist.length; i++) {
         var s = s0 + dist[i][1];
         var bb = s - s0;
         var e = (dist[i][1] - bb) + (s0 - (s - bb)) + s1;
         s0 = s + e;
         s1 = e - (s0 - s);
      }
      var ep = (s0 - 1) + s1;
      console.debug('Total probability: 1 ' + (ep >= 0 ? '+ ' : '- ') + Math.abs(ep).toString());
      var meanscore = 0;
      for (var i = 0; i < dist.length; i++) {
         meanscore += dist[i][0] * dist[i][1];
      }
      document.getElementById('averagescore').innerHTML = meanscore.toFixed(0).toString()
      console.debug('Mean score: ' + meanscore.toString());
      document.getElementById('resultsmile').innerHTML = (result.baseatt.smile+result.bonusatt.smile).toString()+" (+"+result.bonusatt.smile.toString()+")"
      document.getElementById('resultpure').innerHTML = (result.baseatt.pure+result.bonusatt.pure).toString()+" (+"+result.bonusatt.pure.toString()+")"
      document.getElementById('resultcool').innerHTML = (result.baseatt.cool+result.bonusatt.cool).toString()+" (+"+result.bonusatt.cool.toString()+")"
      console.debug(result);
      for (i in scores){
         document.getElementById('simresult'+(100-percentiles[i]*100).toString()).innerHTML = scores[i].toString()
      }
      baseatt = result.baseatt[mapcenter['map']]+result.bonusatt[mapcenter['map']]
      document.getElementById('resultstrength').innerHTML = (result.averagescore/result.minscore*baseatt).toFixed(0).toString()
      document.getElementById('averageheal').innerHTML = result.averageheal
      console.debug(scores);
      totalaccuracy = 0
      ttweight = 0
      ttstrength = 0
      for (i=0;i<9;i++)
         ttweight += member[i]['weight']
      for (i=0;i<9;i++){
         st = member[i][mapcenter['map']]+parseInt(Math.round(averageskillscore[i]/result.minscore*baseatt).toFixed(0))
         //st = (averageskillscore[i]/result.minscore*baseatt).toFixed(0)
         if (mapcenter['map'] == member[i]['main'])
            st += member[i]['kizuna']
         else
            st -= Math.round(baseatt*0.1/1.1*member[i]['weight']/ttweight)
         if (mapcenter['bonus'] == mapcenter['map'])
            st += Math.round(member[i][mapcenter['base']]*mapcenter['percentage']/100)
         if (mapcenter['bonus2'] == mapcenter['map'])
            st += Math.round(member[i][mapcenter['base2']]*mapcenter['percentage2']/100)
         document.getElementById('strength'+String(i)).innerHTML = st.toString()
         //if (averageaccuracy[i] != 0)
         totalaccuracy += (1-totalaccuracy)*(averageaccuracy[i]/100)   
         //if (averageheal[i] != 0)
         document.getElementById('heal'+String(i)).innerHTML = averageheal[i].toString()
         ttstrength += st
      }
      document.getElementById('resultstrength').innerHTML = ttstrength.toFixed(0).toString()
      minstrength = 100000000
      minwhich = -1
      for (i=0;i<9;i++){
         document.getElementById('strength'+String(i)).style.color = ''
         if (parseInt(document.getElementById('strength'+String(i)).innerHTML) < minstrength){
            minwhich = i
            minstrength = parseInt(document.getElementById('strength'+String(i)).innerHTML)
         }
         trueacc = 100*(averageaccuracy[i]/100)*(1-totalaccuracy)/(1-averageaccuracy[i]/100)
         document.getElementById('accuracy'+String(i)).innerHTML = trueacc.toFixed(1).toString()+'%('+averageaccuracy[i].toString()+'%)'
      }
      document.getElementById('averageaccuracy').innerHTML = (totalaccuracy*100).toFixed(1).toString()+'%'
      document.getElementById('result').style.display = ""
      document.getElementById('strength'+String(minwhich)).style.color = 'red'
   }

   function callback(){
   	alert('4')
   }
   </script>
  </head>
 <body onload="init()" lang="zh-Hans">
 <nav class="navbar navbar-default" role="navigation">
   <div class="navbar-header">
      <a class="navbar-brand" href="/">LLhelper</a>
   </div>
   <div>
      <ul class="nav navbar-nav">
         <li><a href="/">应用</a></li>
         <li class="active"><a href=#>队伍强度、得分计算</a></li>
         <li><a href="/about">关于</a></li>
      </ul>
   </div>
</nav>
<pre>
使用方法：
	1、选择歌曲 或 填写歌曲详细信息 <font style='color:red'><b>务必记得修改perfect数量</b></font>
	2、从卡牌库中选择一张卡，点击转移来放置到对应位置，没有录入的卡片数据可以手动输入 <font style='color:red'><b>一张卡默认为满级、一级技能的数据，若不是则需要修改</b></font>
	3、使用以上方法选择所有的9张卡
	4、可以点击”保存队伍“将队伍配置文件保存到本地
	5、第2、3步可以从保存的文件中读取队伍信息来代替：点击”选择文件“选择本地配置文件，再点击”读取队伍“
	6、选择主唱技能和好友主唱技能 <font style='color:red'><b>计算SM得分时将好友主唱加成设为0%</b></font>
	7、点击Calculate

当前版本：4.0以前。更新版本：<a href="/llnewunit">4.1</a>；<a href="llnewunit40">4.0</a>
</pre>
<input type="submit" name="clear" value="清空输入" onclick="clearall()"><br>
<form action="" id="unitform" name="unitform" method="POST" onsubmit="return check()" enctype=multipart/form-data>
<!--<form action="/llloadunit"  onsubmit=""  target="if">-->
<h3>歌曲信息</h3>
搜索：<input type="text" id="songsearch" name="songsearch" value="" onchange="changesongselect()"></input><br>
筛选：<select id="diff" name="diff" onchange="changediffinfo();changesongselect()">
		<option value="">难度</option>
		<option value="easy">easy</option>
		<option value="normal">normal</option>
		<option value="hard">hard</option>
		<option value="expert">expert</option>
	</select>
	<select id="songatt" name="songatt" onchange="changesongselect()">
		<option value="">属性</option>
		<option value="smile">smile</option>
		<option value="pure">pure</option>
		<option value="cool">cool</option>
	</select>
	<select id="songcnhave" name="songcnhave" onchange="changediffinfo();changesongselect()">
		<option value="">国服是否有</option>
		<option value=1>国服有</option>
	</select>
	<select id="type" name="type" onchange="changesongselect()">
		<option value="">类型</option>
		<option value="普通曲">普通曲</option>
		<option value="活动曲">活动曲</option>
		<option value="日替">日替</option>
	</select>
   <select id="smfilter" name="smfilter" onchange="changesongselect();changediffinfo()">
      <option value="">SM查询</option>
      <option value="1">第一次SM</option>
      <option value="2">第二次SM</option>
      <option value="3">第三次SM</option>
      <option value="4">第四次SM</option>
      <option value="5">第五次SM</option>
      <option value="6">第六次SM</option>
      <option value="7">第七次SM</option>
      <option value="8">第八次SM</option>
      <option value="9">第九次SM</option>
      <option value="10">第十次SM</option>
      <option value="11">第十一次SM</option>
      <option value="12">第十二次SM</option>
      <option value="13">第十三次SM</option>
      <option value="14">第十四次SM</option>
      <option value="15">第十五次SM</option>
      <option value="16">第十六次SM</option>
      <option value="17">第十七次SM</option>
      <option value="18">第十八次SM</option>
      <option value="19">第十九次SM</option>
   </select>
   <select id="mffilter" name="mffilter" onchange="changesongselect();changediffinfo()">
      <option value="">MF查询</option>
      <option value="1">第一次MF</option>
      <option value="2">第二次MF</option>
      <option value="3">第三次MF</option>
      <option value="4">第四次MF</option>
      <option value="5">第五次MF</option>
      <option value="6">第六次MF</option>
   </select><br>
歌曲：<select id="songchoice" name="songchoice" onchange="changediffinfo();changesongcolor('songchoice')">
		<option value=""> </option>
	</select>
	<input type="button" id="language" name="language" onclick="changeLanguage()" value="切换语言"></input>
	<br>
   难度：<select id="diffchoice" name="diffchoice" onchange="changesongcolor('songchoice')">
      <option value="easy">easy</option>
      <option value="normal">normal</option>
      <option value="hard" SELECTED>hard</option>
      <option value="expert">expert</option>
   </select><br>
	图属性 :<select id="map" name="map">
		<option value="smile">smile</option>
		<option value="pure">pure</option>
		<option value="cool">cool</option>
	</select><br>
	位置权重 :<input type="text" id="weight" name="position" value="25" autocomplete="off" style="width:50px">（即角色所在位置在一首歌内出现的单点的个数+1.25*长按个数）<br>
	总combo数 :<input type="text" id="combo" name="combo" value="300" autocomplete="off" style="width:50px"><br>
	长按比例 :<input type="text" id="slider" name="slider" value="10" autocomplete="off" style="width:50px">%<br>
	perfect数:<input type="text" id="perfect" name="perfect" value="285" autocomplete="off" style="width:50px"><br>
	时间:<input type="text" id="time" name="time" value="100" autocomplete="off" style="width:50px">秒（从人物出现到最后一个note被击打的时间，不是歌曲长度）<br>
	星星数:<input type="text" id="star" name="star" value="50" autocomplete="off" style="width:50px">个<br>
	星星perfect数:<input type="text" id="starperfect" name="starperfect" value="47" autocomplete="off" style="width:50px">（只有星星系加分需要填写）<br>
<br>
<h3>卡片库</h3>
筛选：<select id="rarity" name="rarity" onchange="changecardselect()">
      <option value="">稀有度</option>
      <option value="N">N</option>
      <option value="R">R</option>
      <option value="SR">SR</option>
      <option value="UR">UR</option>
   </select>
   <select id="chr" name="chr" onchange="changecardselect()">
      <option value="">角色</option>
      <option value="高坂穗乃果">高坂穗乃果</option>
      <option value="绚濑绘里">绚濑绘里</option>
      <option value="南小鸟">南小鸟</option>
      <option value="园田海未">园田海未</option>
      <option value="星空凛">星空凛</option>
      <option value="西木野真姬">西木野真姬</option>
      <option value="东条希">东条希</option>
      <option value="小泉花阳">小泉花阳</option>
      <option value="矢泽妮可">矢泽妮可</option>
   </select>
   <select id="att" name="att" onchange="changecardselect()">
      <option value="">属性</option>
      <option value="smile" style="color:red">smile</option>
      <option value="pure" style="color:green">pure</option>
      <option value="cool" style="color:blue">cool</option>
   </select>
   <select id="cnhave" name="cnhave" onchange="changecardselect()">
      <option value="">国服是否有</option>
      <option value=1>国服有</option>
   </select>
   </select>
   <select id="triggertype" name="triggertype" onchange="changecardselect()">
      <option value="">触发类型</option>
      <option value="1">时间</option>
      <option value="3">图标</option>
      <option value="4">combo</option>
      <option value="5">分数</option>
      <option value="6">perfect</option>
      <option value="12">星星perfect</option>
   </select>
   <select id="skilltype" name="skilltype" onchange="changecardselect()">
      <option value="">技能类型</option>
      <option value="4">小判定</option>
      <option value="5">大判定</option>
      <option value="9">回血</option>
      <option value="11">加分</option>
   </select>
   <select id="cardtype" name="cardtype" onchange="changecardselect()">
      <option value="">卡片类型</option>
      <option value="活动卡">活动卡</option>
      <option value="登录奖励">登录奖励</option>
   </select>
   <select id="special" name="special" onchange="changecardselect()">
      <option value="">是否特典卡</option>
      <option value=0>不是特典</option>
      <option value=1>是特典</option>
   </select>
   <select id="setname" name="setname" onchange="changecardselect()">
      <option value="">套卡名</option>
      <option value="初期">初期</option>
      <option value="職業編">职业篇</option>
      <option value="動物編">动物篇</option>
      <option value="8月編">8月篇</option>
      <option value="9月編">9月篇</option>
      <option value="10月編">10月篇</option>
      <option value="11月編">11月篇</option>
      <option value="12月編">12月篇</option>
      <option value="1月編">1月篇</option>
      <option value="2月編">2月篇</option>
      <option value="3月編">3月篇</option>
      <option value="4月編">4月篇</option>
      <option value="5月編">5月篇</option>
      <option value="6月編">6月篇</option>
      <option value="7月編">7月篇</option>
      <option value="チャイナドレス編">旗袍篇</option>
      <option value="カフェメイド編">女仆篇</option>
      <option value="ハロウィン編">万圣篇</option>
      <option value="星座編">星座篇</option>
      <option value="雪山編">雪山篇</option>
      <option value="七福神編">七福神篇</option>
      <option value="バレンタイン編">情人节篇</option>
      <option value="ホワイトデー編">白色情人节篇</option>
      <option value="職業編(Part2">职业篇2</option>
      <option value="サイバー編">电玩篇</option>
      <option value="手品師編">魔术师篇</option>
      <option value="マリン編">海兵篇</option>
      <option value="プール編">泳池篇</option>
      <option value="くのいち編">忍者篇</option>
      <option value="動物編(Part2)">动物篇2</option>
      <option value="舞踏会編">舞踏会篇</option>
      <option value="クリスマス編">圣诞篇</option>
      <option value="サーカス編">马戏团篇</option>
      <option value="妖精の国編">妖精之国篇</option>
   </select>
   <input type="checkbox" id="showncard" name="showncard" onchange="changecardselect()">显示N卡</input>
   <br>
卡片：<select id="cardchoice" name="cardchoice" onchange="skilllevel = 0;changeskilllevel();changecolor('cardchoice')">
		<option value=""> </option>
	</select>
	<input type="checkbox" id="mezame" name="mezame" onclick="toMezame()">觉醒</input><input type="button" id="language" name="language" onclick="changeLanguage()" value="切换语言"></input>
	（特典卡需选择觉醒）<br>
<div style="float:left">
	smile :<input type="text" id="smile" name="smile" value="0" autocomplete="off" style="color:red"></input><br>
	pure :<input type="text" id="pure" name="pure" value="0" autocomplete="off" style="color:green"><br>
	cool :<input type="text" id="cool" name="cool" value="0" autocomplete="off" style="color:blue"><br>
	主属性 :<select id="main" name="main">
		<option value="smile" style="color:red">smile</option>
		<option value="pure" style="color:green">pure</option>
		<option value="cool" style="color:blue">cool</option>
	</select><br>
	绊:<input type="text" id="kizuna" name="kizuna" value="0" autocomplete="off" ><br>

	技能 :<select id="skill" name="skill" onchange="changeskilltext('')">
		<option value=0>无</option>
		<option value=1>图标系加分</option>
		<option value=2>perfect系加分</option>
		<option value=3>分数系加分</option>
		<option value=4>时间系加分</option>
		<option value=5>时间系判定</option>
		<option value=6>图标系判定</option>
		<option value=7>图标系回血</option>
		<option value=8>时间系回血</option>
		<option value=9>perfect系回血</option>
		<option value=10>星星perfect系加分</option>
		<option value=11>combo系加分</option>
		<option value=12>combo系判定</option>
		<option value=13>combo系回血</option>
	</select><br><nobr>
	</div>
<div style="float:left">
<img id="imageselect">
</div>
<div style="clear:both">
</div>
	<p id="skilltext" style="display:none">
   技能等级 : <input type="button" style="height:20px;width:20px;padding:0" value="▲" onclick="lvlup()"></input> Lv<nospan id="skilllevel">1</nospan> <input type="button" style="height:20px;width:20px;padding:0" value="▼" onclick="lvldown()"></input><br>
	技能效果 :每<input type="text" id="require" name="require" value="0" autocomplete="off" size=3></input>
	<nobr id="requiretext"></nobr>
	<input type="text" id="possibility" name="possibility" value="0" autocomplete="off" size=1>%概率</input>
	<nobr id="effecttext"></nobr>
	<input type="text" id="score" name="score" value="0" autocomplete="off" size=1>
	<nobr id="unittext"></nobr>
	</input></nobr><br>
	</p>


<h3>队伍属性</h3>
<div>
<div style="float:left">
<table border='1'>
	<td ><img  id='avatar0' src='/static/null.png'/></td>
	<td><img  id='avatar1' src='/static/null.png'/></td>
	<td><img  id='avatar2' src='/static/null.png'/></td>
	<td><img  id='avatar3' src='/static/null.png'/></td>
	<td><img  id='avatar4' src='/static/null.png'/></td>
	<td><img  id='avatar5' src='/static/null.png'/></td>
	<td><img  id='avatar6' src='/static/null.png'/></td>
	<td><img  id='avatar7' src='/static/null.png'/></td>
	<td><img  id='avatar8' src='/static/null.png'/></td>
</table>
</div>
<div style="float:left">

<input type="button" value="保存队伍" onclick="saveunit()">
<input type="file" name="file"/>
<input type="submit" value="读取队伍" onclick="loadunit()">

</div>
</div>
<div style="clear:both">
</div>

主唱技能 :<select id="bonus" name="bonus">
		<option value="smile" style="color:red">smile</option>
		<option value="pure" style="color:green">pure</option>
		<option value="cool" style="color:blue">cool</option>
	</select>增加<select id="base" name="base">
      <option value="smile" style="color:red">smile</option>
      <option value="pure" style="color:green">pure</option>
      <option value="cool" style="color:blue">cool</option>
   </select>的<select id="percentage" name="percentage">
      <option value=0>0</option>
      <option value=3>3</option>
      <option value=6 SELECTED>6</option>
      <option value=9>9</option>
      <option value=12>12</option>
   </select>%<br>
好友主唱技能 :<select id="bonus2" name="bonus2">
		<option value="smile" style="color:red">smile</option>
      <option value="pure" style="color:green">pure</option>
      <option value="cool" style="color:blue">cool</option>
	</select>增加<select id="base2" name="base2">
      <option value="smile" style="color:red">smile</option>
      <option value="pure" style="color:green">pure</option>
      <option value="cool" style="color:blue">cool</option>
   </select>的<select id="percentage2" name="percentage2">
      <option value=0>0</option>
      <option value=3>3</option>
      <option value=6>6</option>
      <option value=9 SELECTED>9</option>
      <option value=12>12</option>
   </select>%<br>
	
<table border="1">
<tr>
	<td>位置</td>
	<td>权重</td>
	<td style="display:none">卡片id</td>
	<td style="display:none">觉醒</td>
	<td>主属性</td>
	<td style="color:red">smile</td>
	<td style="color:green">pure</td>
	<td style="color:blue">cool</td>
	<td>绊</td>
	<td>技能</td>
	<td>效果</td>
	<td></td>
	<td>强度</td>
   <td>判定*(1)</td>
   <td>回复</td>
</tr>	
{% for i in range(0,9) %}
<tr>
	<td>{{i+1}}</td>
	<td><input type="text" id="weight{{i}}" name="weight{{i}}" size=1 autocomplete="off"></td>
	<td style="display:none"><input type="text" id="cardid{{i}}" name="cardid{{i}}" size=1 value=0 autocomplete="off"></td>
	<td style="display:none"><input type="text" id="mezame{{i}}" name="mezame{{i}}" size=1 value=0 autocomplete="off"></td>
	<td>
		<select id="main{{i}}" name="main{{i}}">
			<option value="smile" style="color:red">smile</option>
			<option value="pure" style="color:green">pure</option>
			<option value="cool" style="color:blue">cool</option>
		</select>
	</td>
	<td><input type="text" style="color:red" id="smile{{i}}" name="smile{{i}}" size=3 autocomplete="off"></td>
	<td><input type="text" style="color:green" id="pure{{i}}" name="pure{{i}}" size=3 autocomplete="off"></td>
	<td><input type="text" style="color:blue" id="cool{{i}}" name="cool{{i}}" size=3 autocomplete="off"></td>
	<td><input type="text" id="kizuna{{i}}" name="kizuna{{i}}" size=3 autocomplete="off"></td>
	<td>
	<select id="skill{{i}}" name="skill{{i}}" onchange="changeskilltext({{i}})">
		<option value=0>无</option>
		<option value=1>图标系加分</option>
		<option value=2>perfect系加分</option>
		<option value=3>分数系加分</option>
		<option value=4>时间系加分</option>
		<option value=5>时间系判定</option>
		<option value=6>图标系判定</option>
		<option value=7>图标系回血</option>
		<option value=8>时间系回血</option>
		<option value=9>perfect系回血</option>
		<option value=10>星星perfect系加分</option>
		<option value=11>combo系加分</option>
		<option value=12>combo系判定</option>
		<option value=13>combo系回血</option>
	</select>Lv<input type="text" id="skilllevel{{i}}" name="skilllevel{{i}}" value="1" autocomplete="off" size=1 style="width:20px" onchange="changeunitskilllevel({{i}})"></td>
	<td><p id="skilltext{{i}}">每<input type="text" id="require{{i}}" name="require{{i}}" value="0" autocomplete="off" size=3></input>
	<nobr id="requiretext{{i}}"></nobr>
	<input type="text" id="possibility{{i}}" name="possibility{{i}}" value="0" autocomplete="off" size=1>%概率</input>
	<nobr id="effecttext{{i}}"></nobr>
	<input type="text" id="score{{i}}" name="score{{i}}" value="0" autocomplete="off" size=1>
	<nobr id="unittext{{i}}"></nobr>
	</input></p></td>
	<td><input type="button" value="从卡片库放入{{i+1}}" onclick="copyTo({{i}})"></td>
	<td id="strength{{i}}"></td>
   <td id="accuracy{{i}}"></td>
   <td id="heal{{i}}"></td>
</tr>
{% endfor %}
</table>
<input type="button" value="calculate" onclick="check()"> <br><br>
</form>

<iframe style="display:none" id='if' name='if' src='about:blank' frameborder='0' allowtransparency="yes"></iframe>

<pre>
注意：
   得分分布使用真实分布计算
   由于使用歌曲信息计算，最终结果可能会有千分之一的误差
   判定覆盖率仅供参考
说明：   
   1、在卡片数据行中的判定指的该卡片的边际判定覆盖率影响，即撤掉这张卡后边际覆盖率的损失。在括号中的覆盖率为单卡判定覆盖率
</pre>

<div id="result" style="display:none">
<table border="1">
<tr>
	<td>smile</td>
	<td>pure</td>
	<td>cool</td>
</tr>
<tr>
	<td id="resultsmile"></td>
	<td id="resultpure"></td>
	<td id="resultcool"></td>
</tr>
</table>
卡组强度:<nospan id="resultstrength"></nospan><br>
期望得分:<nospan id="averagescore"></nospan><br>

期望回复:<nospan id="averageheal"></nospan><br>

期望判定覆盖率：<nospan id="averageaccuracy"></nospan><br>

<h3>得分分布</h3>
<table border="1">
<tr>
	<td>1%</td>
	<td>2%</td>
	<td>5%</td>
	<td>10%</td>
	<td>20%</td>
	<td>30%</td>
	<td>40%</td>
	<td>50%</td>
	<td>60%</td>
	<td>70%</td>
	<td>80%</td>
	<td>90%</td>
	<td>95%</td>
	<td>98%</td>
	<td>99%</td>
</tr>
<tr>
	<td id='simresult1'></td>
   <td id='simresult2'></td>
   <td id='simresult5'></td>
   <td id='simresult10'></td>
   <td id='simresult20'></td>
   <td id='simresult30'></td>
   <td id='simresult40'></td>
   <td id='simresult50'></td>
   <td id='simresult60'></td>
   <td id='simresult70'></td>
   <td id='simresult80'></td>
   <td id='simresult90'></td>
   <td id='simresult95'></td>
   <td id='simresult98'></td>
   <td id='simresult99'></td>
</tr>
</div>

</body>
{% include 'footer.html' %}
</html>